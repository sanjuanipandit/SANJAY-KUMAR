
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticketing System V1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Design System */
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-orange-500-rgb: 168, 75, 47;
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-300-rgb: 167, 169, 169;
                --color-gray-200-rgb: 245, 245, 245;
                --color-bg-1: rgba(29, 78, 216, 0.15);
                --color-bg-2: rgba(180, 83, 9, 0.15);
                --color-bg-3: rgba(21, 128, 61, 0.15);
                --color-bg-4: rgba(185, 28, 28, 0.15);
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
                --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-btn-primary-text: var(--color-slate-900);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
                --color-error: var(--color-red-400);
                --color-success: var(--color-teal-300);
                --color-warning: var(--color-orange-400);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            font-size: var(--font-size-base);
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-16) var(--space-24);
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-24);
        }

        .logo {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--space-16);
        }

        .user-select {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .login-view {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-background) 0%, var(--color-surface) 100%);
            padding: var(--space-24);
        }

        .login-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-32);
            max-width: 900px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .login-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .login-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-32);
            box-shadow: var(--shadow-lg);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--space-32);
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: var(--space-16);
        }

        .login-title {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-8);
        }

        .login-subtitle {
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-20);
        }

        .login-footer {
            margin-top: var(--space-24);
            padding-top: var(--space-24);
            border-top: 1px solid var(--color-border);
        }

        .login-info {
            background-color: var(--color-bg-1);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
        }

        .user-dropdown {
            position: relative;
        }

        .user-dropdown-btn {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-8) var(--space-16);
            background-color: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            color: var(--color-text);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .user-dropdown-btn:hover {
            background-color: var(--color-secondary-hover);
        }

        .user-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 240px;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            display: none;
        }

        .user-dropdown-menu.active {
            display: block;
        }

        .user-menu-header {
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-border);
        }

        .user-menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-12) var(--space-16);
            background: none;
            border: none;
            color: var(--color-text);
            font-size: var(--font-size-sm);
            text-align: left;
            cursor: pointer;
            transition: background-color var(--duration-fast) var(--ease-standard);
        }

        .user-menu-item:hover {
            background-color: var(--color-secondary);
        }

        .user-menu-item i {
            width: 16px;
            text-align: center;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-16);
        }

        .users-table th,
        .users-table td {
            padding: var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .users-table th {
            background-color: var(--color-secondary);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--color-text);
        }

        .users-table tr:hover {
            background-color: var(--color-secondary);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-8);
        }

        .action-btn {
            padding: var(--space-4) var(--space-8);
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .action-btn-edit {
            background-color: var(--color-bg-1);
            color: var(--color-primary);
        }

        .action-btn-edit:hover {
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .action-btn-delete {
            background-color: var(--color-bg-4);
            color: var(--color-error);
        }

        .action-btn-delete:hover {
            background-color: var(--color-error);
            color: var(--color-btn-primary-text);
        }

        .action-btn-deactivate {
            background-color: var(--color-bg-2);
            color: var(--color-warning);
        }

        .action-btn-deactivate:hover {
            background-color: var(--color-warning);
            color: var(--color-btn-primary-text);
        }

        .user-badge {
            padding: var(--space-4) var(--space-12);
            background-color: var(--color-bg-1);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .main-content {
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: var(--space-24);
        }

        .nav-tabs {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-24);
            border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: var(--space-12) var(--space-20);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-secondary);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .nav-tab:hover {
            color: var(--color-text);
            background-color: var(--color-secondary);
        }

        .nav-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-8);
        }

        .card-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-24);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-16);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
        }

        .form-label .required {
            color: var(--color-error);
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            font-size: var(--font-size-base);
            font-family: var(--font-family-base);
            transition: border-color var(--duration-fast) var(--ease-standard);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: var(--space-12) var(--space-24);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background-color: var(--color-secondary-hover);
        }

        .filters {
            display: flex;
            gap: var(--space-12);
            margin-bottom: var(--space-24);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .filter-label {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-32);
        }

        .stat-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-md);
            padding: var(--space-16);
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }

        .tickets-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
        }

        .ticket-item {
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-md);
            padding: var(--space-16);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .ticket-item:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-12);
            gap: var(--space-16);
        }

        .ticket-id {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }

        .ticket-title-text {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin: var(--space-4) 0;
        }

        .ticket-meta {
            display: flex;
            gap: var(--space-12);
            flex-wrap: wrap;
            align-items: center;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .badge {
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
        }

        .badge-status-open {
            background-color: var(--color-bg-2);
            color: var(--color-warning);
        }

        .badge-status-assigned {
            background-color: var(--color-bg-1);
            color: var(--color-primary);
        }

        .badge-status-in-progress {
            background-color: var(--color-bg-3);
            color: var(--color-success);
        }

        .badge-status-closed {
            background-color: var(--color-bg-4);
            color: var(--color-error);
        }

        .badge-priority-low {
            background-color: var(--color-bg-3);
            color: var(--color-success);
        }

        .badge-priority-medium {
            background-color: var(--color-bg-2);
            color: var(--color-warning);
        }

        .badge-priority-high {
            background-color: var(--color-bg-4);
            color: var(--color-error);
        }



        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: var(--space-24);
        }

        .modal-content {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            max-width: 900px;
            width: 100%;
            margin: var(--space-24) 0;
            box-shadow: var(--shadow-md);
        }

        .modal-header {
            padding: var(--space-24);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-2xl);
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-base);
            transition: background-color var(--duration-fast) var(--ease-standard);
        }

        .modal-close:hover {
            background-color: var(--color-secondary);
        }

        .modal-body {
            padding: var(--space-24);
            max-height: 70vh;
            overflow-y: auto;
        }

        .ticket-detail-section {
            margin-bottom: var(--space-24);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-12);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .detail-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }

        .detail-value {
            font-size: var(--font-size-base);
            color: var(--color-text);
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
            margin-top: var(--space-12);
        }

        .comment-item {
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-12);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-8);
        }

        .comment-author {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
        }

        .comment-date {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .comment-text {
            font-size: var(--font-size-sm);
            color: var(--color-text);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
            margin-top: var(--space-12);
        }

        .history-item {
            display: flex;
            gap: var(--space-12);
            padding: var(--space-8);
            font-size: var(--font-size-sm);
        }

        .history-date {
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
            min-width: 140px;
        }

        .history-action {
            color: var(--color-text);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }

        .success-message {
            background-color: var(--color-bg-3);
            color: var(--color-success);
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            border: 1px solid var(--color-success);
        }

        .error-message {
            background-color: var(--color-bg-4);
            color: var(--color-error);
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            border: 1px solid var(--color-error);
        }

        .help-text {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
        }

        /* SLA Timer Styles */
        .sla-timer {
            display: inline-flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
        }

        .sla-green {
            background-color: var(--color-bg-3);
            color: var(--color-success);
        }

        .sla-yellow {
            background-color: var(--color-bg-2);
            color: var(--color-warning);
        }

        .sla-red {
            background-color: var(--color-bg-4);
            color: var(--color-error);
        }

        /* Search Bar */
        .search-bar-container {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            flex: 1;
            max-width: 900px;
        }
        
        .search-container {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: var(--space-8) var(--space-12) var(--space-8) var(--space-32);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            font-size: var(--font-size-base);
        }

        .search-icon {
            position: absolute;
            left: var(--space-12);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
        }

        .clear-search-btn {
            position: absolute;
            right: var(--space-12);
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .clear-search-btn:hover {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        .advanced-search-panel {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
            display: none;
        }

        .advanced-search-panel.active {
            display: block;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-16);
            padding: var(--space-12);
            background-color: var(--color-bg-1);
            border-radius: var(--radius-base);
        }

        .search-match-count {
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        .highlight {
            background-color: rgba(255, 193, 133, 0.4);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: var(--font-weight-semibold);
        }

        .saved-searches-dropdown {
            position: relative;
            display: inline-block;
        }

        .saved-searches-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 280px;
            max-width: 400px;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .saved-searches-menu.active {
            display: block;
        }

        .saved-search-item {
            padding: var(--space-12) var(--space-16);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background-color var(--duration-fast) var(--ease-standard);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-search-item:hover {
            background-color: var(--color-secondary);
        }

        .search-shortcuts-hint {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-8);
            display: flex;
            gap: var(--space-16);
            flex-wrap: wrap;
        }

        .shortcut-example {
            display: inline-flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-8);
            background-color: var(--color-secondary);
            border-radius: var(--radius-sm);
            font-family: var(--font-family-mono);
        }

        .search-history-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-history-dropdown.active {
            display: block;
        }

        .search-history-item {
            padding: var(--space-8) var(--space-12);
            cursor: pointer;
            transition: background-color var(--duration-fast) var(--ease-standard);
            display: flex;
            align-items: center;
            gap: var(--space-8);
            font-size: var(--font-size-sm);
        }

        .search-history-item:hover {
            background-color: var(--color-secondary);
        }

        /* Quick Filter Buttons */
        .quick-filters {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }

        .quick-filter-btn {
            padding: var(--space-8) var(--space-16);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .quick-filter-btn:hover {
            background-color: var(--color-secondary);
        }

        .quick-filter-btn.active {
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
            border-color: var(--color-primary);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: var(--space-16) 0;
        }

        /* Notification Badge */
        .notification-badge {
            position: relative;
            cursor: pointer;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--color-error);
            color: var(--color-btn-primary-text);
            border-radius: var(--radius-full);
            padding: 2px 6px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
        }

        /* Notification Panel */
        .notification-panel {
            position: absolute;
            top: 60px;
            right: var(--space-24);
            width: 350px;
            max-height: 500px;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            display: none;
            overflow-y: auto;
        }

        .notification-panel.active {
            display: block;
        }

        .notification-header {
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-border);
            font-weight: var(--font-weight-semibold);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: var(--space-12);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background-color var(--duration-fast) var(--ease-standard);
        }

        .notification-item:hover {
            background-color: var(--color-secondary);
        }

        .notification-item.unread {
            background-color: var(--color-bg-1);
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            background: none;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-8);
            cursor: pointer;
            color: var(--color-text);
            font-size: var(--font-size-lg);
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .theme-toggle:hover {
            background-color: var(--color-secondary);
        }

        /* Tag Styles */
        .tag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-8);
            background-color: var(--color-secondary);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .tag-remove {
            cursor: pointer;
            color: var(--color-error);
        }

        /* KB Article Card */
        .kb-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-md);
            padding: var(--space-16);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
            margin-bottom: var(--space-12);
        }

        .kb-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: var(--space-24);
            right: var(--space-24);
            padding: var(--space-12) var(--space-16);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            box-shadow: var(--shadow-lg);
            z-index: 1002;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-color: var(--color-success);
            background-color: var(--color-bg-3);
        }

        .toast.error {
            border-color: var(--color-error);
            background-color: var(--color-bg-4);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Comment Type Toggle */
        .comment-type-toggle {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }

        .comment-type-btn {
            padding: var(--space-6) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background-color: var(--color-surface);
            color: var(--color-text);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .comment-type-btn.active {
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
            border-color: var(--color-primary);
        }

        .comment-internal {
            border-left: 3px solid var(--color-warning);
        }

        .comment-public {
            border-left: 3px solid var(--color-success);
        }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-12);
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-8);
        }

        .leaderboard-rank {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-secondary);
            min-width: 40px;
        }

        .leaderboard-rank.top {
            color: var(--color-warning);
        }

        /* Pagination */
        .pagination {
            display: flex;
            gap: var(--space-8);
            justify-content: center;
            align-items: center;
            margin-top: var(--space-24);
        }

        .pagination-btn {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-surface);
            color: var(--color-text);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--color-secondary);
        }

        .pagination-btn.active {
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
            border-color: var(--color-primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Settings Panel */
        .settings-section {
            margin-bottom: var(--space-32);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-16);
        }

        /* File Upload */
        .file-upload-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
            margin-top: var(--space-8);
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-8);
            background-color: var(--color-secondary);
            border-radius: var(--radius-sm);
        }

        .file-remove {
            color: var(--color-error);
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: var(--space-12);
            justify-content: flex-end;
            margin-top: var(--space-24);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            box-shadow: var(--shadow-lg);
            z-index: 1003;
            max-width: 400px;
            width: 90%;
        }

        .confirm-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1002;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-12);
            }

            .search-bar-container {
                flex-direction: column;
                width: 100%;
                max-width: 100%;
            }
            
            .search-container {
                max-width: 100%;
                width: 100%;
            }
            
            .search-bar-container .btn {
                width: 100%;
            }

            .user-info {
                width: 100%;
                flex-wrap: wrap;
                gap: var(--space-8);
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .quick-filters {
                flex-direction: column;
            }

            .quick-filter-btn {
                width: 100%;
            }

            .notification-panel {
                right: var(--space-8);
                left: var(--space-8);
                width: auto;
            }

            .ticket-header {
                flex-direction: column;
            }

            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login View -->
        <div id="loginView" class="login-view">
            <div class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <div class="login-logo">🎫</div>
                        <h1 class="login-title">Ticketing System V1.0</h1>
                        <p class="login-subtitle">Please sign in to continue</p>
                    </div>
                    <div id="loginError" class="error-message" style="display: none;"></div>
                    <form id="loginForm" class="login-form">
                        <div class="form-group">
                            <label class="form-label">User ID</label>
                            <input type="text" id="loginUserId" class="form-input" placeholder="Enter your user ID" required autocomplete="username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required autocomplete="current-password">
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; gap: var(--space-8);">
                            <input type="checkbox" id="rememberMe" style="width: auto;">
                            <label for="rememberMe" style="margin: 0; font-weight: normal; cursor: pointer;">Remember me</label>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
                    </form>
                    <div class="login-footer">
                        <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center;">
                            Having trouble? Contact admin@company.com
                        </p>
                    </div>
                </div>
                <div class="login-info">
                    <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-16);">Demo Accounts</h3>
                    <div style="display: flex; flex-direction: column; gap: var(--space-12);">
                        <div>
                            <strong>Admin:</strong> admin / Admin@123
                        </div>
                        <div>
                            <strong>Collections Lead:</strong> rahul.col / Pass@123
                        </div>
                        <div>
                            <strong>Team Member:</strong> priya.col / Pass@123
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App View (Hidden until logged in) -->
        <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-content">
                <div class="logo">🎫 Ticketing System V1.0</div>
                <div class="search-bar-container">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="globalSearch" class="search-input" placeholder="Search by ticket #, title, description, reporter, assignee..." autocomplete="off">
                        <button id="clearSearchBtn" class="clear-search-btn" onclick="clearSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <button id="searchBtn" class="btn btn-primary" onclick="performSearch()" style="padding: var(--space-8) var(--space-16);" title="Search">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button id="clearFilterBtn" class="btn btn-secondary" onclick="clearSearch()" style="padding: var(--space-8) var(--space-16); display: none;" title="Clear">
                        <i class="fas fa-times"></i> Clear
                    </button>
                    <button class="btn btn-secondary" onclick="toggleAdvancedSearch()" style="padding: var(--space-8) var(--space-16);" title="Advanced Search">
                        <i class="fas fa-sliders-h"></i> Advanced
                    </button>
                    <button id="goToTicketBtn" class="btn btn-secondary" onclick="showGoToTicket()" style="padding: var(--space-8) var(--space-16);" title="Go to Ticket">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                </div>
                <div class="user-info">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <div class="notification-badge" onclick="toggleNotifications()">
                        <i class="fas fa-bell" style="font-size: var(--font-size-xl);"></i>
                        <span id="notificationCount" class="notification-count" style="display: none;">0</span>
                    </div>
                    <div class="user-dropdown">
                        <button class="user-dropdown-btn" onclick="toggleUserMenu()">
                            <i class="fas fa-user-circle"></i>
                            <span id="currentUserName"></span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="userDropdownMenu" class="user-dropdown-menu">
                            <div class="user-menu-header">
                                <div id="userMenuName" style="font-weight: var(--font-weight-semibold);"></div>
                                <div id="userMenuRole" style="font-size: var(--font-size-sm); color: var(--color-text-secondary);"></div>
                            </div>
                            <button class="user-menu-item" onclick="showUserProfile()">
                                <i class="fas fa-user"></i> My Profile
                            </button>
                            <button class="user-menu-item" onclick="showChangePassword()">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                            <button class="user-menu-item" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="notificationPanel" class="notification-panel">
                <div class="notification-header">
                    <span>Notifications</span>
                    <button class="btn-secondary" onclick="markAllRead()" style="padding: var(--space-4) var(--space-8); font-size: var(--font-size-xs);">Mark All Read</button>
                </div>
                <div id="notificationList"></div>
            </div>
        </header>
        </div>

        <main class="main-content">
            <nav class="nav-tabs">
                <button class="nav-tab active" data-view="dashboard"><i class="fas fa-home"></i> Dashboard</button>
                <button class="nav-tab" data-view="submit"><i class="fas fa-plus"></i> Submit Ticket</button>
                <button class="nav-tab" data-view="tickets"><i class="fas fa-ticket-alt"></i> All Tickets</button>
                <button class="nav-tab" data-view="analytics" id="analyticsTab"><i class="fas fa-chart-bar"></i> Analytics</button>
                <button class="nav-tab" data-view="knowledge"><i class="fas fa-book"></i> Knowledge Base</button>
                <button class="nav-tab" data-view="settings" id="settingsTab"><i class="fas fa-cog"></i> Settings</button>
                <button class="nav-tab" data-view="users" id="usersTab" style="display: none;"><i class="fas fa-users-cog"></i> User Management</button>
            </nav>

            <!-- User Management View -->
            <div id="users" class="view">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-24);">
                        <div>
                            <h1 class="card-title"><i class="fas fa-users-cog"></i> User Management</h1>
                            <p class="card-subtitle">Manage system users and access control</p>
                        </div>
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            <i class="fas fa-user-plus"></i> Add New User
                        </button>
                    </div>

                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Department</label>
                            <select id="filterUserDepartment" class="form-select" onchange="renderUsersTable()">
                                <option value="">All Departments</option>
                                <option value="Administration">Administration</option>
                                <option value="Collections">Collections</option>
                                <option value="Reconciliation">Reconciliation</option>
                                <option value="Billing">Billing</option>
                                <option value="Sales">Sales</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Role</label>
                            <select id="filterUserRole" class="form-select" onchange="renderUsersTable()">
                                <option value="">All Roles</option>
                                <option value="Admin">Admin</option>
                                <option value="Department Lead">Department Lead</option>
                                <option value="Team Member">Team Member</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select id="filterUserStatus" class="form-select" onchange="renderUsersTable()">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div id="usersTableContainer"></div>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                        <div>
                <h1 class="card-title">Welcome, <span id="dashboardUserName"></span></h1>
                            <p class="card-subtitle">Your personalized ticketing dashboard</p>
                        </div>
                        <button id="exportExcelBtn" class="btn btn-primary" onclick="exportToExcel()" style="display: none;">
                            <i class="fas fa-file-excel"></i> Export to Excel
                        </button>
                    </div>
                    
                    <!-- Advanced Search Panel -->
                    <div id="advancedSearchPanel" class="advanced-search-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-16);">
                            <h3 class="section-title" style="margin: 0;"><i class="fas fa-filter"></i> Advanced Search</h3>
                            <div style="display: flex; gap: var(--space-8);">
                                <div class="saved-searches-dropdown">
                                    <button class="btn btn-secondary" onclick="toggleSavedSearches()" style="padding: var(--space-8) var(--space-12);">
                                        <i class="fas fa-star"></i> Saved Searches (<span id="savedSearchCount">0</span>)
                                    </button>
                                    <div id="savedSearchesMenu" class="saved-searches-menu"></div>
                                </div>
                                <button class="btn btn-secondary" onclick="toggleAdvancedSearch()" style="padding: var(--space-8) var(--space-12);">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Ticket Number</label>
                                <input type="text" id="advSearchTicketId" class="form-input" placeholder="e.g., TKT-00001 or 00001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title Contains</label>
                                <input type="text" id="advSearchTitle" class="form-input" placeholder="Search in title">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description Contains</label>
                                <input type="text" id="advSearchDescription" class="form-input" placeholder="Search in description">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reporter Name/Email</label>
                                <input type="text" id="advSearchReporter" class="form-input" placeholder="Reporter name or email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Assignee</label>
                                <select id="advSearchAssignee" class="form-select">
                                    <option value="">All Assignees</option>
                                    <option value="unassigned">Unassigned</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department</label>
                                <select id="advSearchDepartment" class="form-select">
                                    <option value="">All Departments</option>
                                    <option value="Collections">Collections</option>
                                    <option value="Reconciliation">Reconciliation</option>
                                    <option value="Billing">Billing</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status (Multiple)</label>
                                <select id="advSearchStatus" class="form-select" multiple style="height: auto;">
                                    <option value="Open">Open</option>
                                    <option value="Assigned">Assigned</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Closed">Closed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priority (Multiple)</label>
                                <select id="advSearchPriority" class="form-select" multiple style="height: auto;">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Issue Type</label>
                                <select id="advSearchIssueType" class="form-select">
                                    <option value="">All Issue Types</option>
                                    <option value="Bug">Bug</option>
                                    <option value="Feature Request">Feature Request</option>
                                    <option value="Data Issue">Data Issue</option>
                                    <option value="Access Issue">Access Issue</option>
                                    <option value="Process Question">Process Question</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">SLA Status</label>
                                <select id="advSearchSLA" class="form-select">
                                    <option value="">All</option>
                                    <option value="within">Within SLA</option>
                                    <option value="approaching">Approaching SLA</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Created From Date</label>
                                <input type="date" id="advSearchDateFrom" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Created To Date</label>
                                <input type="date" id="advSearchDateTo" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tags</label>
                                <input type="text" id="advSearchTags" class="form-input" placeholder="Search by tags">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Comments Contain</label>
                                <input type="text" id="advSearchComments" class="form-input" placeholder="Search in comments">
                            </div>
                        </div>
                        
                        <div class="form-actions" style="margin-top: var(--space-20);">
                            <button class="btn btn-secondary" onclick="resetAdvancedSearch()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                            <button class="btn btn-secondary" onclick="saveCurrentSearch()">
                                <i class="fas fa-save"></i> Save This Search
                            </button>
                            <button class="btn btn-primary" onclick="performAdvancedSearch()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>

                    <div id="dashboardContent">
                        <div class="stats-grid">
                            <div class="stat-card" style="background-color: var(--color-bg-1);">
                                <div class="stat-label"><i class="fas fa-folder-open"></i> My Open Tickets</div>
                                <div class="stat-value" id="myOpenTickets">0</div>
                            </div>
                            <div class="stat-card" style="background-color: var(--color-bg-2);">
                                <div class="stat-label"><i class="fas fa-user-check"></i> My Assigned Tickets</div>
                                <div class="stat-value" id="myAssignedTickets">0</div>
                            </div>
                            <div class="stat-card" style="background-color: var(--color-bg-3);">
                                <div class="stat-label"><i class="fas fa-building"></i> Department Tickets</div>
                                <div class="stat-value" id="departmentTickets">0</div>
                            </div>
                            <div class="stat-card" style="background-color: var(--color-bg-4);">
                                <div class="stat-label"><i class="fas fa-exclamation-triangle"></i> Overdue Tickets</div>
                                <div class="stat-value" id="overdueTickets">0</div>
                            </div>
                        </div>

                        <!-- Search Results Header -->
                        <div id="searchResultsHeader" style="display: none;"></div>

                        <div class="ticket-detail-section">
                            <h2 class="section-title">Quick Filters</h2>
                            <div class="quick-filters">
                                <button class="quick-filter-btn" onclick="applyQuickFilter('myTickets')"><i class="fas fa-user"></i> My Tickets</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('overdue')"><i class="fas fa-exclamation-triangle"></i> Overdue Tickets</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('approachingSLA')"><i class="fas fa-hourglass-half"></i> Approaching SLA</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('today')"><i class="fas fa-calendar-day"></i> Today's Tickets</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('highPriority')"><i class="fas fa-exclamation-circle"></i> High Priority</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('unassigned')"><i class="fas fa-user-slash"></i> Unassigned</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('thisWeek')"><i class="fas fa-calendar-week"></i> This Week</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('closedToday')"><i class="fas fa-check-circle"></i> Closed Today</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('recentUpdates')"><i class="fas fa-clock"></i> Recent Updates</button>
                                <button class="quick-filter-btn" onclick="applyQuickFilter('all')"><i class="fas fa-list"></i> All Tickets</button>
                            </div>
                        </div>

                        <div class="ticket-detail-section">
                            <h2 class="section-title">Recent Tickets</h2>
                            <div id="recentTickets" class="tickets-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Ticket View -->
            <div id="submit" class="view">
                <div class="card">
                    <h1 class="card-title">Submit New Ticket</h1>
                    <p class="card-subtitle">Fill in the details below to create a new support ticket</p>
                    
                    <div id="submitSuccess" class="success-message" style="display: none;">
                        Ticket submitted successfully! Ticket ID: <strong id="newTicketId"></strong>
                    </div>

                    <form id="ticketForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Reporter Name <span class="required">*</span></label>
                                <input type="text" id="reporterName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reporter Email <span class="required">*</span></label>
                                <input type="email" id="reporterEmail" class="form-input" required>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Ticket Title <span class="required">*</span></label>
                                <input type="text" id="ticketTitle" class="form-input" required placeholder="Brief description of the issue">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department <span class="required">*</span></label>
                                <select id="department" class="form-select" required onchange="populateAssigneeDropdown()">
                                    <option value="">Select Department</option>
                                    <option value="Collections">Collections</option>
                                    <option value="Reconciliation">Reconciliation</option>
                                    <option value="Billing">Billing</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Assign To (Optional)</label>
                                <select id="assignToUser" class="form-select" disabled>
                                    <option value="">-- Select Assignee --</option>
                                </select>
                                <span class="help-text">Select a team member to assign this ticket immediately, or leave unassigned for later</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Issue Type <span class="required">*</span></label>
                                <select id="issueType" class="form-select" required>
                                    <option value="">Select Issue Type</option>
                                    <option value="Bug">Bug</option>
                                    <option value="Feature Request">Feature Request</option>
                                    <option value="Data Issue">Data Issue</option>
                                    <option value="Access Issue">Access Issue</option>
                                    <option value="Process Question">Process Question</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priority <span class="required">*</span></label>
                                <select id="priority" class="form-select" required>
                                    <option value="">Select Priority</option>
                                    <option value="Low">Low</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Description <span class="required">*</span></label>
                                <textarea id="description" class="form-textarea" required placeholder="Provide detailed information about the issue"></textarea>
                                <span class="help-text">Please include steps to reproduce, expected behavior, and any relevant details</span>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Attachments (Optional)</label>
                                <input type="file" id="attachment" class="form-input" multiple>
                                <span class="help-text">Attach screenshots or relevant documents (multiple files allowed)</span>
                                <div id="fileList" class="file-upload-list"></div>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Tags (Optional)</label>
                                <input type="text" id="ticketTags" class="form-input" placeholder="Add tags separated by commas (e.g., urgent, payment, report)">
                                <span class="help-text">Tags help categorize and search tickets</span>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
                            <button type="submit" class="btn btn-primary">Submit Ticket</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- All Tickets View -->
            <div id="tickets" class="view">
                <div class="card">
                    <h1 class="card-title">Ticket Dashboard</h1>
                    <p class="card-subtitle">View and manage support tickets</p>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Department</label>
                            <select id="filterDepartment" class="form-select">
                                <option value="">All Departments</option>
                                <option value="Collections">Collections</option>
                                <option value="Reconciliation">Reconciliation</option>
                                <option value="Billing">Billing</option>
                                <option value="Sales">Sales</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select id="filterStatus" class="form-select">
                                <option value="">All Status</option>
                                <option value="Open">Open</option>
                                <option value="Assigned">Assigned</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Priority</label>
                            <select id="filterPriority" class="form-select">
                                <option value="">All Priorities</option>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>

                    <div id="ticketsList" class="tickets-list"></div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analytics" class="view">
                <div class="card">
                    <h1 class="card-title"><i class="fas fa-chart-line"></i> Analytics &amp; Reports</h1>
                    <p class="card-subtitle">Comprehensive ticket metrics and performance insights</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card" style="background-color: var(--color-bg-1);">
                            <div class="stat-label">Total Tickets</div>
                            <div class="stat-value" id="analyticsTotal">0</div>
                        </div>
                        <div class="stat-card" style="background-color: var(--color-bg-2);">
                            <div class="stat-label">Open/Closed Ratio</div>
                            <div class="stat-value" id="analyticsRatio">0%</div>
                        </div>
                        <div class="stat-card" style="background-color: var(--color-bg-3);">
                            <div class="stat-label">Avg Resolution Time</div>
                            <div class="stat-value" id="analyticsAvgResolution">-</div>
                        </div>
                        <div class="stat-card" style="background-color: var(--color-bg-4);">
                            <div class="stat-label">SLA Compliance</div>
                            <div class="stat-value" id="analyticsSLA">0%</div>
                        </div>
                    </div>

                    <div class="ticket-detail-section">
                        <h2 class="section-title"><i class="fas fa-chart-bar"></i> Department Performance</h2>
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>

                    <div class="ticket-detail-section">
                        <h2 class="section-title"><i class="fas fa-chart-line"></i> Ticket Trends (Last 7 Days)</h2>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <div class="ticket-detail-section">
                        <h2 class="section-title"><i class="fas fa-clock"></i> Ticket Aging Report</h2>
                        <div class="chart-container">
                            <canvas id="agingChart"></canvas>
                        </div>
                    </div>

                    <div class="ticket-detail-section">
                        <h2 class="section-title"><i class="fas fa-pie-chart"></i> Issue Type Distribution</h2>
                        <div class="chart-container">
                            <canvas id="issueTypeChart"></canvas>
                        </div>
                    </div>

                    <div class="ticket-detail-section">
                        <h2 class="section-title"><i class="fas fa-trophy"></i> Assignee Performance Leaderboard</h2>
                        <div id="leaderboardList"></div>
                    </div>

                    <div style="text-align: center; margin-top: var(--space-24);">
                        <button class="btn btn-primary" onclick="exportAnalytics()">
                            <i class="fas fa-download"></i> Export Analytics Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base View -->
            <div id="knowledge" class="view">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-16);">
                        <div>
                            <h1 class="card-title"><i class="fas fa-book-open"></i> Knowledge Base</h1>
                            <p class="card-subtitle">Browse solutions and frequently asked questions</p>
                        </div>
                        <button id="addKBBtn" class="btn btn-primary" onclick="showKBForm()" style="display: none;">
                            <i class="fas fa-plus"></i> Add Article
                        </button>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-24);">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="kbSearch" class="search-input" placeholder="Search knowledge base..." onkeyup="filterKBArticles()">
                        </div>
                    </div>

                    <div id="kbList"></div>

                    <div id="kbFormSection" style="display: none; margin-top: var(--space-24); padding-top: var(--space-24); border-top: 1px solid var(--color-border);">
                        <h2 class="section-title">Add/Edit Knowledge Base Article</h2>
                        <form id="kbForm">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label class="form-label">Article Title <span class="required">*</span></label>
                                    <input type="text" id="kbTitle" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category <span class="required">*</span></label>
                                    <select id="kbCategory" class="form-select" required>
                                        <option value="">Select Category</option>
                                        <option value="Bug Fix">Bug Fix</option>
                                        <option value="How To">How To</option>
                                        <option value="Troubleshooting">Troubleshooting</option>
                                        <option value="FAQ">FAQ</option>
                                        <option value="Process">Process</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Department</label>
                                    <select id="kbDepartment" class="form-select">
                                        <option value="All">All Departments</option>
                                        <option value="Collections">Collections</option>
                                        <option value="Reconciliation">Reconciliation</option>
                                        <option value="Billing">Billing</option>
                                        <option value="Sales">Sales</option>
                                    </select>
                                </div>
                                <div class="form-group full-width">
                                    <label class="form-label">Content <span class="required">*</span></label>
                                    <textarea id="kbContent" class="form-textarea" required style="min-height: 200px;"></textarea>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="cancelKBForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Article</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings" class="view">
                <div class="card">
                    <h1 class="card-title"><i class="fas fa-cog"></i> System Settings</h1>
                    <p class="card-subtitle">Manage users, custom fields, and system configuration</p>

                    <div class="settings-section">
                        <h2 class="section-title"><i class="fas fa-users"></i> User Management</h2>
                        <button class="btn btn-primary" onclick="showAddUserForm()" style="margin-bottom: var(--space-16);">
                            <i class="fas fa-user-plus"></i> Add New User
                        </button>
                        <div id="usersList"></div>
                    </div>

                    <div class="settings-section">
                        <h2 class="section-title"><i class="fas fa-sliders-h"></i> Custom Fields</h2>
                        <button class="btn btn-primary" onclick="showAddFieldForm()" style="margin-bottom: var(--space-16);">
                            <i class="fas fa-plus"></i> Add Custom Field
                        </button>
                        <div id="customFieldsList"></div>
                    </div>

                    <div class="settings-section">
                        <h2 class="section-title"><i class="fas fa-tags"></i> Custom Issue Types</h2>
                        <button class="btn btn-primary" onclick="showAddIssueTypeForm()" style="margin-bottom: var(--space-16);">
                            <i class="fas fa-plus"></i> Add Issue Type
                        </button>
                        <div id="issueTypesList"></div>
                    </div>

                    <div class="settings-section">
                        <h2 class="section-title"><i class="fas fa-tasks"></i> Custom Statuses</h2>
                        <button class="btn btn-primary" onclick="showAddStatusForm()" style="margin-bottom: var(--space-16);">
                            <i class="fas fa-plus"></i> Add Status
                        </button>
                        <div id="statusesList"></div>
                    </div>

                    <div class="settings-section" id="gmailSettingsSection" style="display: none;">
                        <h2 class="section-title"><i class="fas fa-envelope"></i> Gmail Integration <span id="gmailStatusBadge" class="badge badge-status-closed">Not Connected</span></h2>
                        <p style="margin-bottom: var(--space-16); color: var(--color-text-secondary);">Configure Gmail API to automatically send email notifications when tickets are assigned.</p>
                        
                        <div id="gmailSetupInstructions" class="card" style="background-color: var(--color-bg-1); margin-bottom: var(--space-24); padding: var(--space-20);">
                            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-12);">Setup Instructions</h3>
                            <div style="display: flex; flex-direction: column; gap: var(--space-16);">
                                <div>
                                    <strong>Step 1: Create Google Cloud Project</strong>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">1. Go to <a href="https://console.cloud.google.com" target="_blank" style="color: var(--color-primary);">console.cloud.google.com</a></p>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">2. Create new project: "Company Ticketing System"</p>
                                </div>
                                <div>
                                    <strong>Step 2: Enable Gmail API</strong>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">1. Navigate to "APIs &amp; Services" &gt; "Library"</p>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">2. Search "Gmail API" and click "Enable"</p>
                                </div>
                                <div>
                                    <strong>Step 3: Configure OAuth Consent Screen</strong>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">1. Go to "APIs &amp; Services" &gt; "OAuth consent screen"</p>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">2. Select "Internal" (for company use) or "External"</p>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">3. Add scope: https://www.googleapis.com/auth/gmail.send</p>
                                </div>
                                <div>
                                    <strong>Step 4: Create OAuth 2.0 Client ID</strong>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">1. Go to "APIs &amp; Services" &gt; "Credentials"</p>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">2. Click "Create Credentials" &gt; "OAuth 2.0 Client ID"</p>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">3. Application type: "Web application"</p>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">4. Add authorized JavaScript origins (e.g., http://localhost:8080)</p>
                                    <p style="margin: var(--space-4) 0; font-size: var(--font-size-sm);">5. Copy the Client ID (format: xxxxx.apps.googleusercontent.com)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-grid" style="margin-bottom: var(--space-24);">
                            <div class="form-group full-width">
                                <label class="form-label">Google Client ID <span class="required">*</span></label>
                                <input type="text" id="gmailClientId" class="form-input" placeholder="xxxxx.apps.googleusercontent.com">
                                <span class="help-text">Enter your OAuth 2.0 Client ID from Google Cloud Console</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Connection Status</label>
                                <div id="gmailConnectionStatus" style="padding: var(--space-8); background-color: var(--color-bg-4); border-radius: var(--radius-base); color: var(--color-error); font-weight: var(--font-weight-medium);">
                                    <i class="fas fa-times-circle"></i> Not Connected
                                </div>
                            </div>
                            <div class="form-group" id="gmailConnectedEmailGroup" style="display: none;">
                                <label class="form-label">Connected Email</label>
                                <div id="gmailConnectedEmailDisplay" style="padding: var(--space-8); background-color: var(--color-secondary); border-radius: var(--radius-base); font-weight: var(--font-weight-medium);">
                                    -
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: var(--space-12); flex-wrap: wrap;">
                            <button id="gmailConnectBtn" class="btn btn-primary" onclick="initiateGmailAuth()">
                                <i class="fas fa-plug"></i> Connect to Gmail
                            </button>
                            <button id="gmailDisconnectBtn" class="btn btn-secondary" onclick="disconnectGmail()" style="display: none;">
                                <i class="fas fa-unlink"></i> Disconnect
                            </button>
                            <button id="gmailTestBtn" class="btn btn-secondary" onclick="sendTestEmail()" style="display: none;">
                                <i class="fas fa-paper-plane"></i> Send Test Email
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h2 class="section-title"><i class="fas fa-download"></i> Export Audit Log</h2>
                        <button class="btn btn-primary" onclick="exportAuditLog()">
                            <i class="fas fa-file-excel"></i> Export Complete Audit Trail
                        </button>
                    </div>
                </div>
            </div>

            <!-- Old Stats View (kept for compatibility) -->
            <div id="stats" class="view">
                <div class="card">
                    <h1 class="card-title">Ticket Statistics</h1>
                    <p class="card-subtitle">Overview of ticket metrics and performance</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Tickets</div>
                            <div class="stat-value" id="totalTickets">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Open Tickets</div>
                            <div class="stat-value" id="openTickets">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Closed Tickets</div>
                            <div class="stat-value" id="closedTickets">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Resolution Time</div>
                            <div class="stat-value" id="avgResolution">-</div>
                        </div>
                    </div>

                    <div class="ticket-detail-section">
                        <h2 class="section-title">Tickets by Department</h2>
                        <div id="departmentStats" class="stats-grid"></div>
                    </div>

                    <div class="ticket-detail-section">
                        <h2 class="section-title">Tickets by Priority</h2>
                        <div id="priorityStats" class="stats-grid"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTicketId"></h2>
                <button class="modal-close" onclick="closeTicketModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalError" class="error-message" style="display: none;"></div>
                <div class="ticket-detail-section">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value" id="modalStatus"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Priority</div>
                            <div class="detail-value" id="modalPriority"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Department</div>
                            <div class="detail-value" id="modalDepartment"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Issue Type</div>
                            <div class="detail-value" id="modalIssueType"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Reporter</div>
                            <div class="detail-value" id="modalReporter"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Assigned To</div>
                            <div class="detail-value" id="modalAssignee"></div>
                        </div>
                        <div class="detail-item" id="assigneeEmailContainer" style="display: none;">
                            <div class="detail-label">Assignee Email</div>
                            <div class="detail-value" id="modalAssigneeEmail"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created</div>
                            <div class="detail-value" id="modalCreated"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Updated</div>
                            <div class="detail-value" id="modalUpdated"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">SLA Status</div>
                            <div class="detail-value" id="modalSLA"></div>
                        </div>
                    </div>
                </div>

                <div class="ticket-detail-section" id="tagsSection">
                    <h3 class="section-title">Tags</h3>
                    <div id="modalTags" style="display: flex; gap: var(--space-8); flex-wrap: wrap;"></div>
                </div>

                <div class="ticket-detail-section">
                    <h3 class="section-title">Title</h3>
                    <p id="modalTitle"></p>
                </div>

                <div class="ticket-detail-section">
                    <h3 class="section-title">Description</h3>
                    <p id="modalDescription"></p>
                </div>

                <div class="ticket-detail-section" id="attachmentSection" style="display: none;">
                    <h3 class="section-title">Attachment</h3>
                    <p id="modalAttachment"></p>
                </div>

                <div class="ticket-detail-section" id="assignSection">
                    <h3 class="section-title">Assignment</h3>
                    <div class="form-group">
                        <label class="form-label">Assign to User</label>
                        <select id="assignUser" class="form-select">
                            <option value="">Unassigned</option>
                        </select>
                        <span class="help-text" id="emailNotificationHelp">
                            <i class="fas fa-envelope"></i> An email notification will be sent to the assignee
                            <span id="gmailNotConnectedWarning" style="display: none; color: var(--color-warning);">
                                (Gmail not connected - will use mailto fallback)
                            </span>
                        </span>
                    </div>
                    <div style="display: flex; gap: var(--space-8); margin-top: var(--space-8);">
                        <button class="btn btn-primary" onclick="assignTicket()">
                            <i class="fas fa-user-check"></i> Assign Ticket
                        </button>
                        <button id="resendEmailBtn" class="btn btn-secondary" onclick="resendAssignmentEmail()" style="display: none;">
                            <i class="fas fa-paper-plane"></i> Resend Email
                        </button>
                    </div>
                </div>

                <div class="ticket-detail-section" id="closeTicketSection">
                    <h3 class="section-title">Close Ticket</h3>
                    <button id="closeTicketBtn" class="btn btn-primary" onclick="attemptCloseTicket()" style="margin-top: var(--space-8);">
                        <i class="fas fa-check-circle"></i> Close Ticket
                    </button>
                </div>

                <div class="ticket-detail-section" id="statusSection">
                    <h3 class="section-title">Update Status</h3>
                    <div class="form-group">
                        <label class="form-label">New Status <span class="required" id="closureNote" style="display: none; font-size: var(--font-size-xs); font-weight: normal;">(Comments required to close)</span></label>
                        <select id="updateStatus" class="form-select" onchange="toggleClosureNote()">
                            <!-- Status options will be populated dynamically -->
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="updateTicketStatus()" style="margin-top: var(--space-8);">
                        <i class="fas fa-sync-alt"></i> Update Status
                    </button>
                </div>

                <div class="ticket-detail-section">
                    <h3 class="section-title">Add Comment</h3>
                    <div class="comment-type-toggle">
                        <button class="comment-type-btn active" data-type="public" onclick="selectCommentType('public')">
                            <i class="fas fa-eye"></i> Public
                        </button>
                        <button class="comment-type-btn" data-type="internal" onclick="selectCommentType('internal')">
                            <i class="fas fa-eye-slash"></i> Internal
                        </button>
                    </div>
                    <div class="form-group">
                        <textarea id="commentText" class="form-textarea" placeholder="Add resolution details, updates, or notes here... Use @username to mention someone"></textarea>
                        <span class="help-text">Note: At least one comment is required before closing the ticket. Public comments are visible to reporter, internal comments are team-only.</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Attach Files (Optional)</label>
                        <input type="file" id="commentAttachment" class="form-input" multiple>
                    </div>
                    <button class="btn btn-primary" onclick="addComment()" style="margin-top: var(--space-8);">
                        <i class="fas fa-comment"></i> Add Comment
                    </button>
                </div>

                <div class="ticket-detail-section">
                    <h3 class="section-title">Linked Tickets</h3>
                    <div class="form-group">
                        <input type="text" id="linkTicketId" class="form-input" placeholder="Enter ticket ID to link (e.g., TKT-00001)">
                        <button class="btn btn-secondary" onclick="linkTicket()" style="margin-top: var(--space-8);">
                            <i class="fas fa-link"></i> Link Ticket
                        </button>
                    </div>
                    <div id="linkedTicketsList" style="margin-top: var(--space-12);"></div>
                </div>

                <div class="ticket-detail-section">
                    <h3 class="section-title">Comments</h3>
                    <div id="commentsList" class="comments-list"></div>
                </div>

                <div class="ticket-detail-section">
                    <h3 class="section-title">Ticket History</h3>
                    <div id="historyList" class="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State (In-Memory Storage)
        let currentUser = null;
        let sessionActive = false;
        let lastActivityTime = Date.now();
        let sessionTimeout = 30 * 60 * 1000; // 30 minutes
        let tickets = [];
        let users = [];
        let ticketCounter = 1;
        let loginAttempts = 0;
        let knowledgeBase = [];
        let kbCounter = 1;
        let notifications = [];
        let notificationCounter = 1;
        let customFields = [];
        let customIssueTypes = [];
        let customStatuses = ['Open', 'Assigned', 'In Progress', 'Pending Client', 'Under Review', 'Closed'];
        let currentCommentType = 'public';
        let currentPage = 1;
        let itemsPerPage = 20;
        let currentTheme = 'light';
        let searchHistory = [];
        let savedSearches = [];
        let currentSearchQuery = '';
        let advancedSearchActive = false;
        let searchDebounceTimer = null;
        let slaConfig = {
            High: 8 * 60 * 60 * 1000, // 8 hours in ms
            Medium: 24 * 60 * 60 * 1000, // 24 hours in ms
            Low: 48 * 60 * 60 * 1000 // 48 hours in ms
        };
        let charts = {};
        
        // Gmail API Integration State
        let gmailConnected = false;
        let gmailClientId = '';
        let gmailAccessToken = null;
        let gmailRefreshToken = null;
        let gmailTokenExpiry = null;
        let gmailConnectedEmail = '';
        let gapiLoaded = false;
        let gisLoaded = false;
        let tokenClient = null;

        // Simple hash function for passwords (client-side)
        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // Validate password strength
        function validatePassword(password) {
            if (password.length < 8) {
                return { valid: false, message: 'Password must be at least 8 characters' };
            }
            if (!/[A-Z]/.test(password)) {
                return { valid: false, message: 'Password must contain at least 1 uppercase letter' };
            }
            if (!/[a-z]/.test(password)) {
                return { valid: false, message: 'Password must contain at least 1 lowercase letter' };
            }
            if (!/[0-9]/.test(password)) {
                return { valid: false, message: 'Password must contain at least 1 number' };
            }
            return { valid: true };
        }

        // Check session activity
        function checkSessionActivity() {
            if (sessionActive && currentUser) {
                const now = Date.now();
                if (now - lastActivityTime > sessionTimeout) {
                    showToast('Session expired due to inactivity', 'error');
                    logout();
                }
            }
        }

        // Update activity timestamp
        function updateActivity() {
            lastActivityTime = Date.now();
        }

        // Gmail API Functions
        function initializeGmailAPI() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
                });
                gapiLoaded = true;
            });
        }
        
        function loadGoogleIdentityServices() {
            if (typeof google !== 'undefined' && google.accounts) {
                gisLoaded = true;
            }
        }
        
        function initiateGmailAuth() {
            const clientId = document.getElementById('gmailClientId').value.trim();
            
            if (!clientId) {
                showToast('Please enter a valid Client ID', 'error');
                return;
            }
            
            // Validate Client ID format
            if (!clientId.includes('.apps.googleusercontent.com')) {
                showToast('Invalid Client ID format. Should end with .apps.googleusercontent.com', 'error');
                return;
            }
            
            gmailClientId = clientId;
            
            // Check if popup blocker is active
            const popupTest = window.open('', '_blank', 'width=1,height=1');
            if (!popupTest || popupTest.closed || typeof popupTest.closed === 'undefined') {
                showToast('Popup blocked! Please allow popups for this site and try again.', 'error');
                return;
            }
            popupTest.close();
            
            // Initialize OAuth 2.0 flow using gapi
            const oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';
            
            const params = {
                client_id: clientId,
                redirect_uri: window.location.origin + window.location.pathname,
                response_type: 'token',
                scope: 'https://www.googleapis.com/auth/gmail.send',
                include_granted_scopes: 'true',
                state: 'gmail_auth'
            };
            
            const form = document.createElement('form');
            form.setAttribute('method', 'GET');
            form.setAttribute('action', oauth2Endpoint);
            
            for (const p in params) {
                const input = document.createElement('input');
                input.setAttribute('type', 'hidden');
                input.setAttribute('name', p);
                input.setAttribute('value', params[p]);
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            
            // Open OAuth popup
            const width = 500;
            const height = 600;
            const left = (screen.width / 2) - (width / 2);
            const top = (screen.height / 2) - (height / 2);
            
            const authWindow = window.open(
                '',
                'Gmail Authorization',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            if (!authWindow) {
                showToast('Failed to open authorization window. Please check popup settings.', 'error');
                document.body.removeChild(form);
                return;
            }
            
            form.setAttribute('target', 'Gmail Authorization');
            form.submit();
            document.body.removeChild(form);
            
            showToast('Please complete authorization in the popup window...', 'success');
        }
        
        function handleAuthCallback() {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get('access_token');
                const expiresIn = params.get('expires_in');
                const state = params.get('state');
                
                if (state === 'gmail_auth' && accessToken) {
                    gmailAccessToken = accessToken;
                    gmailTokenExpiry = Date.now() + (parseInt(expiresIn) * 1000);
                    gmailConnected = true;
                    
                    // Get user email
                    getUserEmail();
                    
                    // Clear hash from URL
                    window.location.hash = '';
                    
                    updateGmailConnectionUI();
                    showToast('Gmail connected successfully!', 'success');
                    
                    createNotification({
                        type: 'info',
                        message: 'Gmail API connected successfully',
                        priority: 'Low'
                    });
                }
            }
        }
        
        async function getUserEmail() {
            if (!gmailAccessToken) return;
            
            try {
                const response = await fetch('https://www.googleapis.com/gmail/v1/users/me/profile', {
                    headers: {
                        'Authorization': `Bearer ${gmailAccessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    gmailConnectedEmail = data.emailAddress;
                    document.getElementById('gmailConnectedEmailDisplay').textContent = gmailConnectedEmail;
                }
            } catch (error) {
                console.error('Failed to get user email:', error);
            }
        }
        
        function updateGmailConnectionUI() {
            const statusEl = document.getElementById('gmailConnectionStatus');
            const statusBadge = document.getElementById('gmailStatusBadge');
            const connectBtn = document.getElementById('gmailConnectBtn');
            const disconnectBtn = document.getElementById('gmailDisconnectBtn');
            const testBtn = document.getElementById('gmailTestBtn');
            const emailGroup = document.getElementById('gmailConnectedEmailGroup');
            
            if (gmailConnected) {
                statusEl.style.backgroundColor = 'var(--color-bg-3)';
                statusEl.style.color = 'var(--color-success)';
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                
                statusBadge.className = 'badge badge-status-in-progress';
                statusBadge.textContent = 'Connected';
                
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-flex';
                testBtn.style.display = 'inline-flex';
                emailGroup.style.display = 'block';
            } else {
                statusEl.style.backgroundColor = 'var(--color-bg-4)';
                statusEl.style.color = 'var(--color-error)';
                statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Not Connected';
                
                statusBadge.className = 'badge badge-status-closed';
                statusBadge.textContent = 'Not Connected';
                
                connectBtn.style.display = 'inline-flex';
                disconnectBtn.style.display = 'none';
                testBtn.style.display = 'none';
                emailGroup.style.display = 'none';
            }
        }
        
        function disconnectGmail() {
            if (confirm('Are you sure you want to disconnect Gmail? Email notifications will be disabled.')) {
                gmailConnected = false;
                gmailAccessToken = null;
                gmailRefreshToken = null;
                gmailTokenExpiry = null;
                gmailConnectedEmail = '';
                
                updateGmailConnectionUI();
                showToast('Gmail disconnected', 'success');
                
                createNotification({
                    type: 'info',
                    message: 'Gmail API disconnected',
                    priority: 'Low'
                });
            }
        }
        
        function checkTokenExpiry() {
            if (gmailConnected && gmailTokenExpiry) {
                if (Date.now() > gmailTokenExpiry - 300000) { // 5 minutes before expiry
                    showToast('Gmail token expiring soon. Please reconnect.', 'error');
                    createNotification({
                        type: 'reminder',
                        message: 'Gmail token expiring - please reconnect',
                        priority: 'High'
                    });
                }
            }
        }
        
        async function sendEmailViaGmail(to, subject, body) {
            if (!gmailConnected || !gmailAccessToken) {
                throw new Error('Gmail not connected');
            }
            
            // Check token expiry
            if (Date.now() > gmailTokenExpiry) {
                throw new Error('Token expired');
            }
            
            // Create RFC 2822 formatted email
            const email = [
                `To: ${to}`,
                `Subject: ${subject}`,
                'MIME-Version: 1.0',
                'Content-Type: text/plain; charset=utf-8',
                '',
                body
            ].join('\r\n');
            
            // Encode in base64
            const encodedEmail = btoa(unescape(encodeURIComponent(email)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
            
            // Send via Gmail API
            const response = await fetch('https://www.googleapis.com/gmail/v1/users/me/messages/send', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${gmailAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    raw: encodedEmail
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Failed to send email');
            }
            
            return await response.json();
        }
        
        async function resendAssignmentEmail() {
            const ticketId = document.getElementById('ticketModal').dataset.ticketId;
            const ticket = tickets.find(t => t.id === ticketId);
            
            if (!ticket || !ticket.assignedTo) {
                showToast('No assignee found for this ticket', 'error');
                return;
            }
            
            const assignee = users.find(u => u.id === ticket.assignedTo);
            if (!assignee) {
                showToast('Assignee not found', 'error');
                return;
            }
            
            if (confirm(`Resend assignment email to ${assignee.name} (${assignee.email})?`)) {
                await sendAssignmentEmail(ticket, assignee);
            }
        }
        
        async function sendTestEmail() {
            if (!currentUser) {
                showToast('Please log in first', 'error');
                return;
            }
            
            const testSubject = 'Test Email from Company Ticketing System';
            const testBody = `Hello ${currentUser.name},\n\nThis is a test email from the Company Ticketing System to verify Gmail API integration is working correctly.\n\nIf you received this email, the integration is successful!\n\n---\nCompany Ticketing System\nAutomated Notification`;
            
            try {
                showToast('Sending test email...', 'success');
                await sendEmailViaGmail(currentUser.email, testSubject, testBody);
                showToast(`Test email sent successfully to ${currentUser.email}`, 'success');
            } catch (error) {
                console.error('Test email failed:', error);
                showToast(`Failed to send test email: ${error.message}`, 'error');
                
                if (error.message.includes('Token expired')) {
                    showToast('Token expired. Please reconnect to Gmail.', 'error');
                    disconnectGmail();
                }
            }
        }
        
        // Initialize application
        function initApp() {
            // Initialize Gmail API
            initializeGmailAPI();
            loadGoogleIdentityServices();
            
            // Check for OAuth callback
            handleAuthCallback();
            
            // Check token expiry periodically
            setInterval(checkTokenExpiry, 60000); // Check every minute
            
            // Initialize EmailJS with public key (legacy support)
            emailjs.init('YOUR_PUBLIC_KEY'); // Users should replace with their EmailJS public key
            
            // Create users with authentication credentials
            users = [
                // Admin
                { 
                    id: 1, 
                    userId: 'admin', 
                    password: hashPassword('Admin@123'),
                    name: 'System Administrator', 
                    email: 'admin@company.com', 
                    role: 'Admin', 
                    department: 'Administration',
                    status: 'Active'
                },
                
                // Collections Department
                { 
                    id: 2, 
                    userId: 'rahul.col', 
                    password: hashPassword('Pass@123'),
                    name: 'Rahul Sharma', 
                    email: 'rahul.collections@company.com', 
                    role: 'Department Lead', 
                    department: 'Collections',
                    status: 'Active'
                },
                { 
                    id: 3, 
                    userId: 'priya.col', 
                    password: hashPassword('Pass@123'),
                    name: 'Priya Patel', 
                    email: 'priya.collections@company.com', 
                    role: 'Team Member', 
                    department: 'Collections',
                    status: 'Active'
                },
                
                // Reconciliation Department
                { 
                    id: 4, 
                    userId: 'amit.rec', 
                    password: hashPassword('Pass@123'),
                    name: 'Amit Kumar', 
                    email: 'amit.recon@company.com', 
                    role: 'Department Lead', 
                    department: 'Reconciliation',
                    status: 'Active'
                },
                { 
                    id: 5, 
                    userId: 'sneha.rec', 
                    password: hashPassword('Pass@123'),
                    name: 'Sneha Reddy', 
                    email: 'sneha.recon@company.com', 
                    role: 'Team Member', 
                    department: 'Reconciliation',
                    status: 'Active'
                },
                
                // Billing Department
                { 
                    id: 6, 
                    userId: 'vikram.bil', 
                    password: hashPassword('Pass@123'),
                    name: 'Vikram Singh', 
                    email: 'vikram.billing@company.com', 
                    role: 'Department Lead', 
                    department: 'Billing',
                    status: 'Active'
                },
                { 
                    id: 7, 
                    userId: 'anjali.bil', 
                    password: hashPassword('Pass@123'),
                    name: 'Anjali Gupta', 
                    email: 'anjali.billing@company.com', 
                    role: 'Team Member', 
                    department: 'Billing',
                    status: 'Active'
                },
                
                // Sales Department
                { 
                    id: 8, 
                    userId: 'karan.sal', 
                    password: hashPassword('Pass@123'),
                    name: 'Karan Mehta', 
                    email: 'karan.sales@company.com', 
                    role: 'Department Lead', 
                    department: 'Sales',
                    status: 'Active'
                },
                { 
                    id: 9, 
                    userId: 'neha.sal', 
                    password: hashPassword('Pass@123'),
                    name: 'Neha Joshi', 
                    email: 'neha.sales@company.com', 
                    role: 'Team Member', 
                    department: 'Sales',
                    status: 'Active'
                }
            ];

            // Initialize login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            // Create sample tickets for demonstration
            createSampleTickets();
            
            // Create sample knowledge base articles
            createSampleKBArticles();
            
            // Initialize SLA monitoring
            setInterval(updateSLATimers, 30000); // Update every 30 seconds
            
            // Initialize global search with debouncing
            const globalSearchInput = document.getElementById('globalSearch');
            globalSearchInput.addEventListener('input', debounceSearch);
            globalSearchInput.addEventListener('focus', showSearchHistory);
            globalSearchInput.addEventListener('keydown', handleSearchKeydown);
            globalSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });
            
            // Populate assignee dropdown in advanced search
            populateAdvancedSearchAssignees();
            
            // Check for overdue tickets periodically
            setInterval(checkOverdueTickets, 60000); // Check every minute

            // Event listeners
            document.addEventListener('click', updateActivity);
            document.addEventListener('keypress', updateActivity);
            setInterval(checkSessionActivity, 60000); // Check every minute
            
            // Show login view initially
            document.getElementById('ticketForm').addEventListener('submit', handleTicketSubmit);
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });
            document.getElementById('filterDepartment').addEventListener('change', renderTicketsList);
            document.getElementById('filterStatus').addEventListener('change', renderTicketsList);
            document.getElementById('filterPriority').addEventListener('change', renderTicketsList);
        }

        function createSampleTickets() {
            const sampleTickets = [
                {
                    title: 'Payment not reflected in system',
                    department: 'Collections',
                    issueType: 'Data Issue',
                    priority: 'High',
                    description: 'Customer made payment 3 days ago but it is not showing in the collections dashboard.',
                    reporterName: 'John Customer',
                    reporterEmail: 'john.customer@email.com',
                    status: 'Open'
                },
                {
                    title: 'Invoice totals not matching',
                    department: 'Billing',
                    issueType: 'Bug',
                    priority: 'Critical',
                    description: 'Invoice #12345 shows incorrect total. Line items sum to $500 but total shows $550.',
                    reporterName: 'Jane Manager',
                    reporterEmail: 'jane.m@company.com',
                    status: 'In Progress',
                    assignedTo: 10
                },
                {
                    title: 'Need access to sales reports',
                    department: 'Sales',
                    issueType: 'Access Issue',
                    priority: 'Medium',
                    description: 'New team member needs access to Q4 sales reporting dashboard.',
                    reporterName: 'Tom Wilson',
                    reporterEmail: 'tom.w@company.com',
                    status: 'Closed',
                    assignedTo: 1
                }
            ];

            sampleTickets.forEach(ticket => {
                createTicket(ticket);
            });
        }

        function createSampleKBArticles() {
            const sampleArticles = [
                {
                    title: 'How to Reset Your Password',
                    category: 'How To',
                    department: 'All',
                    content: 'To reset your password:\n1. Click on "Forgot Password" on the login page\n2. Enter your email address\n3. Check your email for reset instructions\n4. Click the reset link and create a new password\n5. Use your new password to log in'
                },
                {
                    title: 'Common Payment Processing Issues',
                    category: 'Troubleshooting',
                    department: 'Collections',
                    content: 'If a payment is not reflecting in the system:\n1. Verify the payment date and amount\n2. Check if the customer reference number is correct\n3. Allow 24 hours for processing\n4. If still not showing, create a ticket with payment details\n5. Include transaction ID and bank reference'
                },
                {
                    title: 'Invoice Total Mismatch Resolution',
                    category: 'Bug Fix',
                    department: 'Billing',
                    content: 'When invoice totals don\'t match line items:\n1. Verify tax calculations are correct\n2. Check for any discounts applied\n3. Look for rounding differences\n4. Regenerate the invoice if needed\n5. Contact IT if issue persists'
                },
                {
                    title: 'How to Generate Sales Reports',
                    category: 'How To',
                    department: 'Sales',
                    content: 'Steps to generate sales reports:\n1. Navigate to Reports section\n2. Select date range\n3. Choose report type (weekly/monthly/quarterly)\n4. Apply any filters needed\n5. Click "Generate Report"\n6. Export to Excel if required'
                }
            ];
            
            sampleArticles.forEach(article => {
                createKBArticle(article);
            });
        }

        function createKBArticle(data) {
            const article = {
                id: `KB-${String(kbCounter++).padStart(4, '0')}`,
                ...data,
                createdAt: new Date(),
                createdBy: currentUser ? currentUser.name : 'System'
            };
            knowledgeBase.push(article);
            return article;
        }

        function createTicket(ticketData) {
            const now = new Date();
            
            // Determine initial status based on assignment
            let initialStatus = 'Open';
            if (ticketData.assignedTo) {
                initialStatus = 'Assigned';
            }
            
            const ticket = {
                id: `TKT-${String(ticketCounter++).padStart(5, '0')}`,
                ...ticketData,
                status: ticketData.status || initialStatus,
                assignedTo: ticketData.assignedTo || null,
                createdAt: now,
                updatedAt: now,
                comments: [],
                linkedTickets: [],
                tags: ticketData.tags || [],
                attachments: ticketData.attachments || [],
                watchers: [],
                slaDeadline: now.getTime() + slaConfig[ticketData.priority],
                slaBreached: false,
                history: [
                    {
                        timestamp: now,
                        action: 'Ticket created',
                        user: ticketData.reporterName
                    }
                ]
            };
            
            // Add assignment history entry if assigned during creation
            if (ticketData.assignedTo) {
                const assignee = users.find(u => u.id === ticketData.assignedTo);
                if (assignee) {
                    ticket.history.push({
                        timestamp: now,
                        action: `Assigned to ${assignee.name} by ${ticketData.reporterName} at creation`,
                        user: ticketData.reporterName
                    });
                }
            }

            tickets.push(ticket);
            
            // Create notification for department lead
            createNotification({
                type: 'ticket_created',
                message: `New ticket created: ${ticket.id} - ${ticket.title}`,
                ticketId: ticket.id,
                priority: ticket.priority
            });
            
            return ticket;
        }

        async function sendAssignmentEmail(ticket, assignee) {
            // Construct email subject
            const subject = `New Ticket Assigned: ${ticket.department}-${ticket.id} - ${ticket.title}`;
            
            // Construct HTML-formatted email body
            const emailBody = `Hello ${assignee.name},

You have been assigned a new ticket. Please review and take action.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TICKET DETAILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Ticket ID:      ${ticket.id}
Title:          ${ticket.title}
Department:     ${ticket.department}
Priority:       ${ticket.priority}
Issue Type:     ${ticket.issueType}
Status:         ${ticket.status}

Description:
${ticket.description}

Reporter Information:
Name:           ${ticket.reporterName}
Email:          ${ticket.reporterEmail}
Created:        ${formatDateTime(ticket.createdAt)}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ACTION REQUIRED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Please log in to the ticketing system to:
• View complete ticket details
• Update ticket status
• Add resolution comments
• Close ticket when resolved

IMPORTANT: You must add resolution comments before closing this ticket.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

This is an automated notification from Company Ticketing System.
Please do not reply to this email.

For support: admin@company.com`;

            // Try Gmail API first if connected
            if (gmailConnected && gmailAccessToken) {
                try {
                    await sendEmailViaGmail(assignee.email, subject, emailBody);
                    
                    showToast(`Email sent to ${assignee.name}`, 'success');
                    
                    // Log email sent in ticket history
                    ticket.history.push({
                        timestamp: new Date(),
                        action: `Email notification sent to ${assignee.email}`,
                        user: 'System'
                    });
                    
                    createNotification({
                        type: 'info',
                        message: `Email sent to ${assignee.name} for ${ticket.id}`,
                        ticketId: ticket.id,
                        priority: 'Low'
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Gmail API failed:', error);
                    
                    // Log failure
                    ticket.history.push({
                        timestamp: new Date(),
                        action: `Failed to send email via Gmail: ${error.message}`,
                        user: 'System'
                    });
                    
                    // Fallback to mailto
                    showToast('Gmail API failed. Opening email client as fallback...', 'error');
                    const mailtoLink = `mailto:${assignee.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                    window.open(mailtoLink, '_blank');
                    return false;
                }
            } else {
                // Gmail not connected - show warning and use mailto fallback
                showToast('Gmail not connected. Please configure Gmail API in Settings or contact admin.', 'error');
                
                ticket.history.push({
                    timestamp: new Date(),
                    action: `Gmail not configured - used mailto fallback for ${assignee.email}`,
                    user: 'System'
                });
                
                // Fallback to mailto
                const mailtoLink = `mailto:${assignee.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                window.open(mailtoLink, '_blank');
                return false;
            }
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const userId = document.getElementById('loginUserId').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            // Find user
            const user = users.find(u => u.userId === userId);
            
            if (!user) {
                loginAttempts++;
                showLoginError(`Invalid user ID or password. Attempts: ${loginAttempts}`);
                return;
            }
            
            if (user.status === 'Inactive') {
                showLoginError('This account has been deactivated. Please contact administrator.');
                return;
            }
            
            // Verify password
            const hashedPassword = hashPassword(password);
            if (user.password !== hashedPassword) {
                loginAttempts++;
                showLoginError(`Invalid user ID or password. Attempts: ${loginAttempts}`);
                return;
            }
            
            // Successful login
            loginAttempts = 0;
            currentUser = user;
            sessionActive = true;
            lastActivityTime = Date.now();
            
            // Log activity
            createNotification({
                type: 'info',
                message: `${user.name} logged in`,
                priority: 'Low'
            });
            
            // Hide login view, show main app
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            // Update UI with user info
            initializeUserSession();
            
            showToast(`Welcome, ${user.name}!`, 'success');
        }
        
        function showLoginError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        function initializeUserSession() {
            // Update header
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('userMenuName').textContent = currentUser.name;
            document.getElementById('userMenuRole').textContent = `${currentUser.role} • ${currentUser.department}`;
            
            // Update dashboard
            document.getElementById('dashboardUserName').textContent = currentUser.name;
            
            // Pre-fill reporter info
            document.getElementById('reporterName').value = currentUser.name;
            document.getElementById('reporterEmail').value = currentUser.email;
            
            // Update tab visibility based on role
            document.getElementById('analyticsTab').style.display = (currentUser.role === 'Admin' || currentUser.role === 'Department Lead') ? 'block' : 'none';
            document.getElementById('settingsTab').style.display = currentUser.role === 'Admin' ? 'block' : 'none';
            document.getElementById('usersTab').style.display = currentUser.role === 'Admin' ? 'block' : 'none';
            
            // Show Gmail settings for Admin
            if (currentUser.role === 'Admin') {
                document.getElementById('gmailSettingsSection').style.display = 'block';
                updateGmailConnectionUI();
            }
            
            // Update export button visibility
            const exportBtn = document.getElementById('exportExcelBtn');
            exportBtn.style.display = (currentUser.role === 'Admin' || currentUser.role === 'Department Lead') ? 'inline-flex' : 'none';
            
            // Update KB add button
            document.getElementById('addKBBtn').style.display = currentUser.role === 'Admin' ? 'inline-flex' : 'none';
            
            updateDashboard();
            renderTicketsList();
        }
        
        function logout() {
            if (currentUser) {
                createNotification({
                    type: 'info',
                    message: `${currentUser.name} logged out`,
                    priority: 'Low'
                });
            }
            
            // Clear session
            currentUser = null;
            sessionActive = false;
            
            // Reset UI
            document.getElementById('loginView').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
            
            // Close any open menus
            document.getElementById('userDropdownMenu').classList.remove('active');
            hideSearchHistory();
            const savedMenu = document.getElementById('savedSearchesMenu');
            if (savedMenu) savedMenu.classList.remove('active');
            
            showToast('Logged out successfully', 'success');
        }
        
        function toggleUserMenu() {
            const menu = document.getElementById('userDropdownMenu');
            menu.classList.toggle('active');
        }
        
        function showUserProfile() {
            toggleUserMenu();
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title"><i class="fas fa-user-circle"></i> My Profile</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">User ID</div>
                                <div class="detail-value">${currentUser.userId}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Full Name</div>
                                <div class="detail-value">${currentUser.name}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Email</div>
                                <div class="detail-value">${currentUser.email}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Department</div>
                                <div class="detail-value">${currentUser.department}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Role</div>
                                <div class="detail-value">
                                    <span class="badge badge-status-assigned">${currentUser.role}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Status</div>
                                <div class="detail-value">
                                    <span class="badge badge-status-in-progress">${currentUser.status}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ticket-detail-section">
                            <h3 class="section-title">Ticket Statistics</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Assigned to Me</div>
                                    <div class="stat-value">${tickets.filter(t => t.assignedTo === currentUser.id).length}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Resolved by Me</div>
                                    <div class="stat-value">${tickets.filter(t => t.assignedTo === currentUser.id && t.status === 'Closed').length}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Pending</div>
                                    <div class="stat-value">${tickets.filter(t => t.assignedTo === currentUser.id && t.status !== 'Closed').length}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function showChangePassword() {
            toggleUserMenu();
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title"><i class="fas fa-key"></i> Change Password</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="changePasswordError" class="error-message" style="display: none;"></div>
                        <div id="changePasswordSuccess" class="success-message" style="display: none;"></div>
                        
                        <form id="changePasswordForm" onsubmit="handlePasswordChange(event)">
                            <div class="form-group">
                                <label class="form-label">Current Password <span class="required">*</span></label>
                                <input type="password" id="currentPassword" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password <span class="required">*</span></label>
                                <input type="password" id="newPassword" class="form-input" required>
                                <span class="help-text">Min 8 characters, 1 uppercase, 1 lowercase, 1 number</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm New Password <span class="required">*</span></label>
                                <input type="password" id="confirmPassword" class="form-input" required>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Change Password</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const errorEl = document.getElementById('changePasswordError');
            const successEl = document.getElementById('changePasswordSuccess');
            
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            
            // Verify current password
            if (hashPassword(currentPassword) !== currentUser.password) {
                errorEl.textContent = 'Current password is incorrect';
                errorEl.style.display = 'block';
                return;
            }
            
            // Validate new password
            const validation = validatePassword(newPassword);
            if (!validation.valid) {
                errorEl.textContent = validation.message;
                errorEl.style.display = 'block';
                return;
            }
            
            // Check password match
            if (newPassword !== confirmPassword) {
                errorEl.textContent = 'New passwords do not match';
                errorEl.style.display = 'block';
                return;
            }
            
            // Update password
            currentUser.password = hashPassword(newPassword);
            
            successEl.textContent = 'Password changed successfully!';
            successEl.style.display = 'block';
            
            document.getElementById('changePasswordForm').reset();
            
            setTimeout(() => {
                document.querySelector('.modal').remove();
                showToast('Password updated successfully', 'success');
            }, 2000);
        }

        function handleTicketSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please select a user first');
                return;
            }

            const attachmentFiles = document.getElementById('attachment').files;
            const attachments = [];
            for (let file of attachmentFiles) {
                attachments.push(file.name);
            }
            
            const tagsInput = document.getElementById('ticketTags').value;
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
            
            const assignToUserId = document.getElementById('assignToUser').value;
            
            const ticketData = {
                title: document.getElementById('ticketTitle').value,
                department: document.getElementById('department').value,
                issueType: document.getElementById('issueType').value,
                priority: document.getElementById('priority').value,
                description: document.getElementById('description').value,
                reporterName: document.getElementById('reporterName').value,
                reporterEmail: document.getElementById('reporterEmail').value,
                attachments: attachments,
                tags: tags,
                assignedTo: assignToUserId ? parseInt(assignToUserId) : null
            };

            const ticket = createTicket(ticketData);
            
            // Send email notification if assigned during creation
            if (ticket.assignedTo) {
                const assignee = users.find(u => u.id === ticket.assignedTo);
                if (assignee) {
                    sendAssignmentEmail(ticket, assignee);
                }
            }
            
            // Show success message
            document.getElementById('newTicketId').textContent = ticket.id;
            const successMsg = ticket.assignedTo ? 
                `Ticket submitted and assigned successfully! Ticket ID: ${ticket.id}` : 
                `Ticket submitted successfully! Ticket ID: ${ticket.id}`;
            document.getElementById('submitSuccess').textContent = successMsg;
            document.getElementById('submitSuccess').style.display = 'block';
            
            // Reset form
            setTimeout(() => {
                resetForm();
                document.getElementById('submitSuccess').style.display = 'none';
            }, 3000);

            updateDashboard();
            renderTicketsList();
        }

        function resetForm() {
            document.getElementById('ticketForm').reset();
            if (currentUser) {
                document.getElementById('reporterName').value = currentUser.name;
                document.getElementById('reporterEmail').value = currentUser.email;
            }
            // Reset and disable assignee dropdown
            const assigneeSelect = document.getElementById('assignToUser');
            assigneeSelect.innerHTML = '<option value="">-- Select Assignee --</option>';
            assigneeSelect.disabled = true;
        }
        
        function populateAssigneeDropdown() {
            const department = document.getElementById('department').value;
            const assigneeSelect = document.getElementById('assignToUser');
            
            // Clear existing options
            assigneeSelect.innerHTML = '<option value="">-- Select Assignee --</option>';
            
            if (!department) {
                assigneeSelect.disabled = true;
                return;
            }
            
            // Enable dropdown
            assigneeSelect.disabled = false;
            
            // Filter users by department and active status
            const departmentUsers = users.filter(u => {
                // Include users from the selected department OR admins
                return u.status === 'Active' && (u.department === department || u.role === 'Admin');
            });
            
            // Sort: Department Leads first, then Team Members, then Admins
            departmentUsers.sort((a, b) => {
                const roleOrder = { 'Department Lead': 1, 'Team Member': 2, 'Admin': 3 };
                return (roleOrder[a.role] || 99) - (roleOrder[b.role] || 99);
            });
            
            // Add users to dropdown
            departmentUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.role})`;
                assigneeSelect.appendChild(option);
            });
            
            // Add "Unassigned" option at the end
            const unassignedOption = document.createElement('option');
            unassignedOption.value = '';
            unassignedOption.textContent = 'Leave Unassigned';
            assigneeSelect.appendChild(unassignedOption);
        }

        function switchView(viewName) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === viewName);
            });
            
            // Update views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.toggle('active', view.id === viewName);
            });

            // Update content based on view
            if (viewName === 'stats') {
                updateStatistics();
            } else if (viewName === 'analytics') {
                updateAnalytics();
            } else if (viewName === 'tickets') {
                renderTicketsList();
            } else if (viewName === 'dashboard') {
                updateDashboard();
            } else if (viewName === 'knowledge') {
                renderKBArticles();
                document.getElementById('addKBBtn').style.display = currentUser && currentUser.role === 'Admin' ? 'inline-flex' : 'none';
            } else if (viewName === 'users') {
                if (currentUser && currentUser.role === 'Admin') {
                    renderUsersTable();
                } else {
                    showToast('Access denied: Admin only', 'error');
                    switchView('dashboard');
                }
            } else if (viewName === 'settings') {
                if (currentUser && currentUser.role === 'Admin') {
                    renderUsersList();
                } else {
                    showToast('Access denied: Admin only', 'error');
                    switchView('dashboard');
                }
            }
        }

        function updateAnalytics() {
            if (!currentUser) return;
            
            const total = tickets.length;
            const open = tickets.filter(t => t.status !== 'Closed').length;
            const closed = tickets.filter(t => t.status === 'Closed').length;
            const ratio = total > 0 ? Math.round((closed / total) * 100) : 0;
            
            // Calculate SLA compliance
            const closedTickets = tickets.filter(t => t.status === 'Closed');
            const compliant = closedTickets.filter(t => !t.slaBreached).length;
            const slaCompliance = closedTickets.length > 0 ? Math.round((compliant / closedTickets.length) * 100) : 0;
            
            // Calculate average resolution time
            let avgResolution = '-';
            if (closedTickets.length > 0) {
                const totalTime = closedTickets.reduce((sum, t) => {
                    const diff = t.updatedAt - t.createdAt;
                    return sum + diff;
                }, 0);
                const avgMs = totalTime / closedTickets.length;
                const avgHours = Math.round(avgMs / (1000 * 60 * 60));
                avgResolution = `${avgHours}h`;
            }
            
            document.getElementById('analyticsTotal').textContent = total;
            document.getElementById('analyticsRatio').textContent = `${ratio}%`;
            document.getElementById('analyticsAvgResolution').textContent = avgResolution;
            document.getElementById('analyticsSLA').textContent = `${slaCompliance}%`;
            
            // Render all charts
            setTimeout(() => renderAnalyticsCharts(), 100);
        }

        function updateDashboard() {
            if (!currentUser) return;

            const myOpenTickets = tickets.filter(t => 
                t.reporterEmail === currentUser.email && t.status !== 'Closed'
            ).length;

            const myAssignedTickets = tickets.filter(t => 
                t.assignedTo === currentUser.id && t.status !== 'Closed'
            ).length;

            let departmentTickets = 0;
            if (currentUser.role === 'Admin') {
                departmentTickets = tickets.length;
            } else if (currentUser.role === 'Department Lead') {
                departmentTickets = tickets.filter(t => t.department === currentUser.department).length;
            } else {
                departmentTickets = tickets.filter(t => 
                    t.department === currentUser.department && t.status !== 'Closed'
                ).length;
            }

            const overdueCount = tickets.filter(t => 
                t.status !== 'Closed' && Date.now() > t.slaDeadline
            ).length;
            
            document.getElementById('myOpenTickets').textContent = myOpenTickets;
            document.getElementById('myAssignedTickets').textContent = myAssignedTickets;
            document.getElementById('departmentTickets').textContent = departmentTickets;
            document.getElementById('overdueTickets').textContent = overdueCount;

            // Show recent tickets
            const recentTickets = getFilteredTickets().slice(0, 5);
            const recentTicketsEl = document.getElementById('recentTickets');
            
            if (recentTickets.length === 0) {
                recentTicketsEl.innerHTML = '<div class="empty-state">No tickets to display</div>';
            } else {
                recentTicketsEl.innerHTML = recentTickets.map(ticket => createTicketCard(ticket)).join('');
            }
        }

        function getFilteredTickets() {
            if (!currentUser) return [];

            let filtered = [...tickets];

            // Role-based filtering
            if (currentUser.role === 'Department Lead') {
                filtered = filtered.filter(t => t.department === currentUser.department);
            } else if (currentUser.role === 'Team Member') {
                filtered = filtered.filter(t => 
                    t.department === currentUser.department || 
                    t.assignedTo === currentUser.id ||
                    t.reporterEmail === currentUser.email
                );
            }

            // Apply filters from UI
            const deptFilter = document.getElementById('filterDepartment')?.value;
            const statusFilter = document.getElementById('filterStatus')?.value;
            const priorityFilter = document.getElementById('filterPriority')?.value;

            if (deptFilter) {
                filtered = filtered.filter(t => t.department === deptFilter);
            }
            if (statusFilter) {
                filtered = filtered.filter(t => t.status === statusFilter);
            }
            if (priorityFilter) {
                filtered = filtered.filter(t => t.priority === priorityFilter);
            }

            // Sort by creation date (newest first)
            filtered.sort((a, b) => b.createdAt - a.createdAt);

            return filtered;
        }

        function renderTicketsList() {
            if (!currentUser) return;

            const filtered = getFilteredTickets();
            const ticketsListEl = document.getElementById('ticketsList');
            
            if (filtered.length === 0) {
                ticketsListEl.innerHTML = '<div class="empty-state">No tickets match the selected filters</div>';
            } else {
                ticketsListEl.innerHTML = filtered.map(ticket => createTicketCard(ticket)).join('');
            }
        }

        function createTicketCard(ticket, searchQuery = '') {
            const assignee = ticket.assignedTo ? users.find(u => u.id === ticket.assignedTo) : null;
            const statusClass = `badge-status-${ticket.status.toLowerCase().replace(' ', '-')}`;
            const priorityClass = `badge-priority-${ticket.priority.toLowerCase()}`;
            
            // Calculate SLA status
            let slaIndicator = '';
            if (ticket.status !== 'Closed') {
                const now = Date.now();
                const timeRemaining = ticket.slaDeadline - now;
                const totalTime = slaConfig[ticket.priority];
                const percentRemaining = (timeRemaining / totalTime) * 100;
                
                let slaClass = 'sla-green';
                let icon = '<i class="fas fa-check-circle"></i>';
                
                if (timeRemaining < 0 || ticket.slaBreached) {
                    slaClass = 'sla-red';
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                } else if (percentRemaining < 20) {
                    slaClass = 'sla-red';
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                } else if (percentRemaining < 50) {
                    slaClass = 'sla-yellow';
                    icon = '<i class="fas fa-clock"></i>';
                }
                
                const hours = Math.abs(Math.floor(timeRemaining / (1000 * 60 * 60)));
                const minutes = Math.abs(Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60)));
                const timeText = timeRemaining < 0 ? `${hours}h ${minutes}m` : `${hours}h ${minutes}m`;
                
                slaIndicator = `<span class="sla-timer ${slaClass}">${icon} ${timeText}</span>`;
            }
            
            const borderStyle = ticket.slaBreached && ticket.status !== 'Closed' ? 'border-left: 4px solid var(--color-error);' : '';

            return `
                <div class="ticket-item" onclick="openTicketModal('${ticket.id}')" style="${borderStyle}">
                    <div class="ticket-header">
                        <div>
                            <div class="ticket-id">${ticket.id}</div>
                            <div class="ticket-title-text">${searchQuery ? highlightText(ticket.title, searchQuery) : escapeHtml(ticket.title)}</div>
                        </div>
                        <div style="display: flex; gap: var(--space-8); flex-wrap: wrap;">
                            ${slaIndicator}
                            <span class="badge ${statusClass}">${ticket.status}</span>
                            <span class="badge ${priorityClass}">${ticket.priority}</span>
                        </div>
                    </div>
                    <div class="ticket-meta">
                        <span><i class="fas fa-folder"></i> ${ticket.department}</span>
                        <span><i class="fas fa-tag"></i> ${ticket.issueType}</span>
                        <span><i class="fas fa-user"></i> ${ticket.reporterName}</span>
                        ${assignee ? `<span><i class="fas fa-user-check"></i> ${assignee.name}</span>` : ''}
                        <span><i class="fas fa-calendar"></i> ${formatDate(ticket.createdAt)}</span>
                    </div>
                </div>
            `;
        }

        function openTicketModal(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;

            document.getElementById('modalTicketId').textContent = ticketId;
            document.getElementById('modalTitle').textContent = ticket.title;
            document.getElementById('modalStatus').innerHTML = `<span class="badge badge-status-${ticket.status.toLowerCase().replace(' ', '-')}">${ticket.status}</span>`;
            document.getElementById('modalPriority').innerHTML = `<span class="badge badge-priority-${ticket.priority.toLowerCase()}">${ticket.priority}</span>`;
            document.getElementById('modalDepartment').textContent = ticket.department;
            document.getElementById('modalIssueType').textContent = ticket.issueType;
            document.getElementById('modalReporter').textContent = `${ticket.reporterName} (${ticket.reporterEmail})`;
            
            const assignee = ticket.assignedTo ? users.find(u => u.id === ticket.assignedTo) : null;
            document.getElementById('modalAssignee').textContent = assignee ? assignee.name : 'Unassigned';
            
            // Show assignee email if assigned
            if (assignee) {
                document.getElementById('modalAssigneeEmail').textContent = assignee.email;
                document.getElementById('assigneeEmailContainer').style.display = 'block';
            } else {
                document.getElementById('assigneeEmailContainer').style.display = 'none';
            }
            
            document.getElementById('modalCreated').textContent = formatDateTime(ticket.createdAt);
            document.getElementById('modalUpdated').textContent = formatDateTime(ticket.updatedAt);
            document.getElementById('modalDescription').textContent = ticket.description;

            // Attachment
            if (ticket.attachment) {
                document.getElementById('attachmentSection').style.display = 'block';
                document.getElementById('modalAttachment').textContent = ticket.attachment;
            } else {
                document.getElementById('attachmentSection').style.display = 'none';
            }

            // Assignment section - only for admins and department leads
            const canAssign = currentUser && (currentUser.role === 'Admin' || 
                (currentUser.role === 'Department Lead' && currentUser.department === ticket.department));
            document.getElementById('assignSection').style.display = canAssign ? 'block' : 'none';
            
            // Populate assign dropdown with department-specific users
            if (canAssign) {
                const assignSelect = document.getElementById('assignUser');
                assignSelect.innerHTML = '<option value="">Unassigned</option>';
                
                // Filter users: same department OR admins
                const availableUsers = users.filter(u => 
                    u.department === ticket.department || u.role === 'Admin'
                );
                
                availableUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.department})`;
                    assignSelect.appendChild(option);
                });
                
                assignSelect.value = ticket.assignedTo || '';
            }

            // Close Ticket button - only show if ticket is not already closed
            const canCloseTicket = currentUser && ticket.status !== 'Closed' && (currentUser.role === 'Admin' || 
                (currentUser.role === 'Department Lead' && currentUser.department === ticket.department) ||
                ticket.assignedTo === currentUser.id);
            document.getElementById('closeTicketSection').style.display = canCloseTicket ? 'block' : 'none';
            
            // Status update section - only for assigned users, admins, and department leads
            const canUpdateStatus = currentUser && (currentUser.role === 'Admin' || 
                (currentUser.role === 'Department Lead' && currentUser.department === ticket.department) ||
                ticket.assignedTo === currentUser.id);
            document.getElementById('statusSection').style.display = canUpdateStatus ? 'block' : 'none';
            
            // Populate status dropdown with custom statuses
            const statusSelect = document.getElementById('updateStatus');
            statusSelect.innerHTML = customStatuses.map(status => 
                `<option value="${status}">${status}</option>`
            ).join('');
            statusSelect.value = ticket.status;
            toggleClosureNote(); // Show/hide closure note based on current status

            // Comments
            renderComments(ticket);

            // History
            renderHistory(ticket);

            // Clear any error messages
            hideModalError();
            
            // Display SLA status
            displaySLAStatus(ticket);
            
            // Display tags
            displayTags(ticket);
            
            // Display linked tickets
            displayLinkedTickets(ticket);
            
            document.getElementById('ticketModal').classList.add('active');
            document.getElementById('ticketModal').dataset.ticketId = ticketId;
        }

        function displaySLAStatus(ticket) {
            if (ticket.status === 'Closed') {
                document.getElementById('modalSLA').innerHTML = '<span class="badge badge-status-closed">Closed</span>';
                return;
            }
            
            const now = Date.now();
            const timeRemaining = ticket.slaDeadline - now;
            const totalTime = slaConfig[ticket.priority];
            const percentRemaining = (timeRemaining / totalTime) * 100;
            
            let slaClass = 'sla-green';
            let icon = '<i class="fas fa-check-circle"></i>';
            
            if (timeRemaining < 0 || ticket.slaBreached) {
                slaClass = 'sla-red';
                icon = '<i class="fas fa-exclamation-triangle"></i>';
            } else if (percentRemaining < 20) {
                slaClass = 'sla-red';
                icon = '<i class="fas fa-exclamation-circle"></i>';
            } else if (percentRemaining < 50) {
                slaClass = 'sla-yellow';
                icon = '<i class="fas fa-clock"></i>';
            }
            
            const hours = Math.abs(Math.floor(timeRemaining / (1000 * 60 * 60)));
            const minutes = Math.abs(Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60)));
            const timeText = timeRemaining < 0 ? `Overdue by ${hours}h ${minutes}m` : `${hours}h ${minutes}m remaining`;
            
            document.getElementById('modalSLA').innerHTML = `<span class="sla-timer ${slaClass}">${icon} ${timeText}</span>`;
        }

        function displayTags(ticket) {
            const tagsEl = document.getElementById('modalTags');
            if (!ticket.tags || ticket.tags.length === 0) {
                document.getElementById('tagsSection').style.display = 'none';
            } else {
                document.getElementById('tagsSection').style.display = 'block';
                tagsEl.innerHTML = ticket.tags.map(tag => 
                    `<span class="tag"><i class="fas fa-tag"></i> ${tag}</span>`
                ).join('');
            }
        }

        function displayLinkedTickets(ticket) {
            const linkedEl = document.getElementById('linkedTicketsList');
            if (!ticket.linkedTickets || ticket.linkedTickets.length === 0) {
                linkedEl.innerHTML = '<p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">No linked tickets</p>';
            } else {
                linkedEl.innerHTML = ticket.linkedTickets.map(linkedId => {
                    const linkedTicket = tickets.find(t => t.id === linkedId);
                    return linkedTicket ? `
                        <div style="padding: var(--space-8); background-color: var(--color-secondary); border-radius: var(--radius-sm); margin-bottom: var(--space-8); display: flex; justify-content: space-between; align-items: center;">
                            <span onclick="openTicketModal('${linkedId}')" style="cursor: pointer; color: var(--color-primary);">
                                <i class="fas fa-link"></i> ${linkedId} - ${linkedTicket.title}
                            </span>
                            <i class="fas fa-times" onclick="unlinkTicket('${ticket.id}', '${linkedId}')" style="cursor: pointer; color: var(--color-error);"></i>
                        </div>
                    ` : '';
                }).join('');
            }
        }

        function linkTicket() {
            const currentTicketId = document.getElementById('ticketModal').dataset.ticketId;
            const linkTicketId = document.getElementById('linkTicketId').value.trim().toUpperCase();
            
            if (!linkTicketId) {
                showToast('Please enter a ticket ID', 'error');
                return;
            }
            
            const currentTicket = tickets.find(t => t.id === currentTicketId);
            const targetTicket = tickets.find(t => t.id === linkTicketId);
            
            if (!targetTicket) {
                showToast('Ticket not found', 'error');
                return;
            }
            
            if (linkTicketId === currentTicketId) {
                showToast('Cannot link ticket to itself', 'error');
                return;
            }
            
            if (currentTicket.linkedTickets.includes(linkTicketId)) {
                showToast('Ticket already linked', 'error');
                return;
            }
            
            currentTicket.linkedTickets.push(linkTicketId);
            targetTicket.linkedTickets.push(currentTicketId);
            
            currentTicket.history.push({
                timestamp: new Date(),
                action: `Linked to ticket ${linkTicketId}`,
                user: currentUser.name
            });
            
            document.getElementById('linkTicketId').value = '';
            showToast('Ticket linked successfully', 'success');
            displayLinkedTickets(currentTicket);
        }

        function unlinkTicket(ticketId, linkedId) {
            const ticket = tickets.find(t => t.id === ticketId);
            const linkedTicket = tickets.find(t => t.id === linkedId);
            
            ticket.linkedTickets = ticket.linkedTickets.filter(id => id !== linkedId);
            linkedTicket.linkedTickets = linkedTicket.linkedTickets.filter(id => id !== ticketId);
            
            ticket.history.push({
                timestamp: new Date(),
                action: `Unlinked from ticket ${linkedId}`,
                user: currentUser.name
            });
            
            showToast('Ticket unlinked', 'success');
            displayLinkedTickets(ticket);
        }

        function closeTicketModal() {
            document.getElementById('ticketModal').classList.remove('active');
            document.getElementById('commentText').value = '';
            hideModalError();
        }

        async function assignTicket() {
            const ticketId = document.getElementById('ticketModal').dataset.ticketId;
            const ticket = tickets.find(t => t.id === ticketId);
            const assigneeId = parseInt(document.getElementById('assignUser').value) || null;
            
            if (ticket) {
                const oldAssignee = ticket.assignedTo ? users.find(u => u.id === ticket.assignedTo) : null;
                const newAssignee = assigneeId ? users.find(u => u.id === assigneeId) : null;
                
                ticket.assignedTo = assigneeId;
                ticket.updatedAt = new Date();
                
                const action = newAssignee 
                    ? `Assigned to ${newAssignee.name} (${newAssignee.email})` 
                    : 'Unassigned ticket';
                
                ticket.history.push({
                    timestamp: new Date(),
                    action: action,
                    user: currentUser.name
                });

                // Auto-update status
                if (assigneeId && ticket.status === 'Open') {
                    ticket.status = 'Assigned';
                    ticket.history.push({
                        timestamp: new Date(),
                        action: 'Status changed from Open to Assigned',
                        user: currentUser.name
                    });
                }
                
                // Send email notification to assignee
                if (newAssignee) {
                    await sendAssignmentEmail(ticket, newAssignee);
                }
                
                openTicketModal(ticketId);
                updateDashboard();
                renderTicketsList();
            }
        }

        function attemptCloseTicket() {
            const ticketId = document.getElementById('ticketModal').dataset.ticketId;
            const ticket = tickets.find(t => t.id === ticketId);
            
            if (!ticket) return;
            
            // Check if ticket already closed
            if (ticket.status === 'Closed') {
                showToast('Ticket is already closed', 'error');
                return;
            }
            
            // Check for existing comments
            if (ticket.comments.length === 0) {
                showMandatoryCommentsModal(ticketId);
            } else {
                // Has comments - show confirmation
                if (confirm('Close this ticket?')) {
                    closeTicketWithComments(ticketId);
                }
            }
        }

        function showMandatoryCommentsModal(ticketId) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'mandatoryCommentsModal';
            modal.style.zIndex = '1010';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title">⚠️ Resolution Comments Required</h2>
                    </div>
                    <div class="modal-body">
                        <div class="error-message" style="display: block; margin-bottom: var(--space-16);">
                            Please add resolution comments before closing this ticket. Comments are mandatory to document the solution.
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Resolution Comments <span class="required">*</span></label>
                            <textarea id="mandatoryCommentText" class="form-textarea" 
                                      placeholder="Enter resolution details, actions taken, and final outcome..." 
                                      rows="6" 
                                      style="min-height: 150px;"></textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-8);">
                                <span class="help-text">Minimum 10 characters required</span>
                                <span id="charCounter" style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">0 / 10</span>
                            </div>
                            <div id="validationError" class="error-message" style="display: none; margin-top: var(--space-8);">
                                Please provide detailed resolution comments (minimum 10 characters)
                            </div>
                        </div>
                        
                        <div class="form-actions" style="margin-top: var(--space-24);">
                            <button type="button" class="btn btn-secondary" onclick="closeMandatoryCommentsModal()">
                                Cancel
                            </button>
                            <button type="button" id="addCommentCloseBtn" class="btn btn-primary" onclick="addCommentAndCloseTicket('${ticketId}')" disabled>
                                <i class="fas fa-comment"></i> Add Comment &amp; Close Ticket
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add character counter and validation
            const textarea = document.getElementById('mandatoryCommentText');
            const counter = document.getElementById('charCounter');
            const submitBtn = document.getElementById('addCommentCloseBtn');
            const validationError = document.getElementById('validationError');
            
            textarea.addEventListener('input', () => {
                const length = textarea.value.trim().length;
                counter.textContent = `${length} / 10`;
                
                if (length >= 10) {
                    submitBtn.disabled = false;
                    counter.style.color = 'var(--color-success)';
                    validationError.style.display = 'none';
                } else {
                    submitBtn.disabled = true;
                    counter.style.color = 'var(--color-text-secondary)';
                }
            });
            
            textarea.focus();
        }

        function closeMandatoryCommentsModal() {
            const modal = document.getElementById('mandatoryCommentsModal');
            if (modal) modal.remove();
        }

        function addCommentAndCloseTicket(ticketId) {
            const commentText = document.getElementById('mandatoryCommentText').value.trim();
            const validationError = document.getElementById('validationError');
            
            // Validate comment length
            if (commentText.length < 10) {
                validationError.style.display = 'block';
                return;
            }
            
            // Validate meaningful text (not just spaces or special chars)
            if (!/[a-zA-Z0-9]{5,}/.test(commentText)) {
                validationError.textContent = 'Please provide meaningful resolution comments with actual content';
                validationError.style.display = 'block';
                return;
            }
            
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            // Add the resolution comment
            const comment = {
                id: Date.now(),
                author: currentUser.name,
                text: commentText,
                type: 'public',
                attachments: [],
                timestamp: new Date(),
                isResolution: true
            };
            
            ticket.comments.push(comment);
            ticket.updatedAt = new Date();
            
            ticket.history.push({
                timestamp: new Date(),
                action: 'Resolution comment added',
                user: currentUser.name
            });
            
            // Close the mandatory comments modal
            closeMandatoryCommentsModal();
            
            // Now close the ticket
            closeTicketWithComments(ticketId);
        }

        function closeTicketWithComments(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            const oldStatus = ticket.status;
            ticket.status = 'Closed';
            ticket.updatedAt = new Date();
            
            ticket.history.push({
                timestamp: new Date(),
                action: `Status changed from ${oldStatus} to Closed`,
                user: currentUser.name
            });
            
            ticket.history.push({
                timestamp: new Date(),
                action: 'Ticket closed with resolution comments',
                user: currentUser.name
            });
            
            // Success notification
            showToast('Ticket closed successfully with resolution comments', 'success');
            
            createNotification({
                type: 'info',
                message: `Ticket ${ticketId} closed by ${currentUser.name}`,
                ticketId: ticketId,
                priority: ticket.priority
            });
            
            // Refresh the modal and dashboard
            openTicketModal(ticketId);
            updateDashboard();
            renderTicketsList();
        }

        function updateTicketStatus() {
            const ticketId = document.getElementById('ticketModal').dataset.ticketId;
            const ticket = tickets.find(t => t.id === ticketId);
            const newStatus = document.getElementById('updateStatus').value;
            
            if (ticket && newStatus !== ticket.status) {
                // If trying to change to Closed, use the mandatory comments workflow
                if (newStatus === 'Closed') {
                    document.getElementById('updateStatus').value = ticket.status; // Reset dropdown
                    attemptCloseTicket();
                    return;
                }
                
                const oldStatus = ticket.status;
                ticket.status = newStatus;
                ticket.updatedAt = new Date();
                
                ticket.history.push({
                    timestamp: new Date(),
                    action: `Status changed from ${oldStatus} to ${newStatus}`,
                    user: currentUser.name
                });
                
                hideModalError();
                
                openTicketModal(ticketId);
                updateDashboard();
                renderTicketsList();
            }
        }

        function showModalError(message) {
            const errorEl = document.getElementById('modalError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            // Scroll to top of modal to show error
            document.querySelector('.modal-body').scrollTop = 0;
        }

        function hideModalError() {
            const errorEl = document.getElementById('modalError');
            errorEl.style.display = 'none';
        }

        function toggleClosureNote() {
            const statusSelect = document.getElementById('updateStatus');
            const closureNote = document.getElementById('closureNote');
            
            if (statusSelect.value === 'Closed') {
                closureNote.style.display = 'inline';
            } else {
                closureNote.style.display = 'none';
            }
        }

        function addComment() {
            const ticketId = document.getElementById('ticketModal').dataset.ticketId;
            const ticket = tickets.find(t => t.id === ticketId);
            const commentText = document.getElementById('commentText').value.trim();
            const attachmentFiles = document.getElementById('commentAttachment').files;
            
            if (!commentText) {
                showModalError('Please enter a comment');
                return;
            }
            
            if (ticket && commentText && currentUser) {
                const attachments = [];
                for (let file of attachmentFiles) {
                    attachments.push(file.name);
                }
                
                const comment = {
                    id: Date.now(),
                    author: currentUser.name,
                    text: commentText,
                    type: currentCommentType,
                    attachments: attachments,
                    timestamp: new Date()
                };
                
                ticket.comments.push(comment);
                ticket.updatedAt = new Date();
                
                // Auto-update status to In Progress on first comment
                if (ticket.comments.length === 1 && ticket.status === 'Assigned') {
                    ticket.status = 'In Progress';
                    ticket.history.push({
                        timestamp: new Date(),
                        action: 'Status auto-updated to In Progress (first comment added)',
                        user: 'System'
                    });
                }
                
                ticket.history.push({
                    timestamp: new Date(),
                    action: `Added a ${currentCommentType} comment`,
                    user: currentUser.name
                });
                
                // Check for @mentions and create notifications
                const mentionRegex = /@(\w+)/g;
                const mentions = commentText.match(mentionRegex);
                if (mentions) {
                    mentions.forEach(mention => {
                        const username = mention.substring(1);
                        const mentionedUser = users.find(u => u.name.toLowerCase().includes(username.toLowerCase()));
                        if (mentionedUser) {
                            createNotification({
                                type: 'mention',
                                message: `${currentUser.name} mentioned you in ${ticketId}`,
                                ticketId: ticketId,
                                userId: mentionedUser.id
                            });
                        }
                    });
                }
                
                // Notify ticket watchers
                if (currentCommentType === 'public' && ticket.reporterEmail) {
                    createNotification({
                        type: 'comment_added',
                        message: `New comment on ${ticketId}: ${ticket.title}`,
                        ticketId: ticketId,
                        priority: ticket.priority
                    });
                }
                
                document.getElementById('commentText').value = '';
                document.getElementById('commentAttachment').value = '';
                hideModalError();
                renderComments(ticket);
                renderHistory(ticket);
                openTicketModal(ticketId); // Refresh modal to show status change if any
            }
        }

        function renderComments(ticket) {
            const commentsEl = document.getElementById('commentsList');
            
            if (ticket.comments.length === 0) {
                commentsEl.innerHTML = '<div class="empty-state" style="padding: var(--space-16);">No comments yet</div>';
            } else {
                commentsEl.innerHTML = ticket.comments.map(comment => {
                    const typeClass = comment.type === 'internal' ? 'comment-internal' : 'comment-public';
                    const typeLabel = comment.type === 'internal' ? '<i class="fas fa-eye-slash"></i> Internal' : '<i class="fas fa-eye"></i> Public';
                    const resolutionBadge = comment.isResolution ? '<span class="badge badge-status-in-progress" style="margin-left: var(--space-8); font-size: var(--font-size-xs);"><i class="fas fa-check-circle"></i> Resolution</span>' : '';
                    const resolutionStyle = comment.isResolution ? 'background-color: var(--color-bg-3); border-left: 3px solid var(--color-success);' : '';
                    const attachments = comment.attachments && comment.attachments.length > 0 ? 
                        `<div style="margin-top: var(--space-8);">
                            ${comment.attachments.map(file => `<span class="tag"><i class="fas fa-paperclip"></i> ${file}</span>`).join(' ')}
                        </div>` : '';
                    
                    return `
                        <div class="comment-item ${typeClass}" style="${resolutionStyle}">
                            <div class="comment-header">
                                <div>
                                    <span class="comment-author">${comment.author}</span>
                                    <span class="badge" style="margin-left: var(--space-8); font-size: var(--font-size-xs);">${typeLabel}</span>
                                    ${resolutionBadge}
                                </div>
                                <span class="comment-date">${formatDateTime(comment.timestamp)}</span>
                            </div>
                            <div class="comment-text">${comment.text}</div>
                            ${attachments}
                        </div>
                    `;
                }).join('');
            }
        }

        function selectCommentType(type) {
            currentCommentType = type;
            document.querySelectorAll('.comment-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
        }

        function renderHistory(ticket) {
            const historyEl = document.getElementById('historyList');
            
            historyEl.innerHTML = ticket.history.map(entry => `
                <div class="history-item">
                    <span class="history-date">${formatDateTime(entry.timestamp)}</span>
                    <span class="history-action">${entry.action} by ${entry.user}</span>
                </div>
            `).join('');
        }

        function updateStatistics() {
            if (!currentUser || currentUser.role !== 'Admin') return;

            const totalTickets = tickets.length;
            const openTickets = tickets.filter(t => t.status !== 'Closed').length;
            const closedTickets = tickets.filter(t => t.status === 'Closed').length;

            // Calculate average resolution time
            const closedWithTime = tickets.filter(t => t.status === 'Closed');
            let avgResolution = '-';
            if (closedWithTime.length > 0) {
                const totalTime = closedWithTime.reduce((sum, t) => {
                    const diff = t.updatedAt - t.createdAt;
                    return sum + diff;
                }, 0);
                const avgMs = totalTime / closedWithTime.length;
                const avgHours = Math.round(avgMs / (1000 * 60 * 60));
                avgResolution = `${avgHours}h`;
            }

            document.getElementById('totalTickets').textContent = totalTickets;
            document.getElementById('openTickets').textContent = openTickets;
            document.getElementById('closedTickets').textContent = closedTickets;
            document.getElementById('avgResolution').textContent = avgResolution;

            // Department statistics
            const departments = ['Collections', 'Reconciliation', 'Billing', 'Sales', 'Other'];
            const deptStats = departments.map(dept => {
                const deptTickets = tickets.filter(t => t.department === dept);
                const open = deptTickets.filter(t => t.status !== 'Closed').length;
                const closed = deptTickets.filter(t => t.status === 'Closed').length;
                return { dept, total: deptTickets.length, open, closed };
            });

            const deptStatsEl = document.getElementById('departmentStats');
            deptStatsEl.innerHTML = deptStats.map(stat => `
                <div class="stat-card">
                    <div class="stat-label">${stat.dept}</div>
                    <div class="stat-value">${stat.total}</div>
                    <div class="stat-label" style="font-size: var(--font-size-xs);">Open: ${stat.open} | Closed: ${stat.closed}</div>
                </div>
            `).join('');

            // Priority statistics
            const priorities = ['Low', 'Medium', 'High'];
            const priorityStats = priorities.map(priority => {
                const count = tickets.filter(t => t.priority === priority).length;
                return { priority, count };
            });

            const priorityStatsEl = document.getElementById('priorityStats');
            priorityStatsEl.innerHTML = priorityStats.map(stat => `
                <div class="stat-card">
                    <div class="stat-label">${stat.priority}</div>
                    <div class="stat-value">${stat.count}</div>
                </div>
            `).join('');
        }

        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatDateTime(date) {
            const d = new Date(date);
            return d.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function formatDateDDMMYYYY(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function formatDateTimeDDMMYYYY(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
        }

        function calculateResolutionTime(ticket) {
            if (ticket.status !== 'Closed') {
                return '';
            }
            const diffMs = ticket.updatedAt - ticket.createdAt;
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            const remainingHours = diffHours % 24;
            
            if (diffDays > 0) {
                return `${diffDays}d ${remainingHours}h`;
            } else {
                return `${diffHours}h`;
            }
        }

        function exportToExcel() {
            // Check if user has permission
            if (!currentUser || (currentUser.role !== 'Admin' && currentUser.role !== 'Department Lead')) {
                showToast('You do not have permission to export tickets', 'error');
                return;
            }

            // Prepare data for export - include ALL tickets
            const exportData = tickets.map(ticket => {
                const assignee = ticket.assignedTo ? users.find(u => u.id === ticket.assignedTo) : null;
                const comments = ticket.comments.map(c => `[${formatDateTimeDDMMYYYY(c.timestamp)}] ${c.author} (${c.type}): ${c.text}`).join(' | ');
                const tags = ticket.tags ? ticket.tags.join(', ') : '';
                const linkedTickets = ticket.linkedTickets ? ticket.linkedTickets.join(', ') : '';
                const slaStatus = ticket.slaBreached ? 'Breached' : 'Met';
                
                return {
                    'Ticket ID': ticket.id,
                    'Title': ticket.title,
                    'Department': ticket.department,
                    'Issue Type': ticket.issueType,
                    'Priority': ticket.priority,
                    'Status': ticket.status,
                    'SLA Status': ticket.status === 'Closed' ? slaStatus : 'In Progress',
                    'Description': ticket.description,
                    'Reporter Name': ticket.reporterName,
                    'Reporter Email': ticket.reporterEmail,
                    'Assigned To': assignee ? assignee.name : 'Unassigned',
                    'Assignee Email': assignee ? assignee.email : '',
                    'Tags': tags,
                    'Linked Tickets': linkedTickets,
                    'Created Date': formatDateDDMMYYYY(ticket.createdAt),
                    'Last Updated Date': formatDateDDMMYYYY(ticket.updatedAt),
                    'Resolution Time': calculateResolutionTime(ticket),
                    'Comments/Notes': comments || 'No comments'
                };
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Set column widths for better readability
            const colWidths = [
                { wch: 12 },  // Ticket ID
                { wch: 35 },  // Title
                { wch: 15 },  // Department
                { wch: 18 },  // Issue Type
                { wch: 10 },  // Priority
                { wch: 12 },  // Status
                { wch: 50 },  // Description
                { wch: 20 },  // Reporter Name
                { wch: 25 },  // Reporter Email
                { wch: 20 },  // Assigned To
                { wch: 15 },  // Created Date
                { wch: 15 },  // Last Updated Date
                { wch: 15 },  // Resolution Time
                { wch: 60 }   // Comments/Notes
            ];
            ws['!cols'] = colWidths;

            // Style the header row (make it bold)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!ws[address]) continue;
                if (!ws[address].s) ws[address].s = {};
                ws[address].s = {
                    font: { bold: true },
                    fill: { fgColor: { rgb: "D3D3D3" } },
                    alignment: { horizontal: "center" }
                };
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Tickets");

            // Generate filename with timestamp
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const filename = `Tickets_Export_${day}${month}${year}_${hours}${minutes}${seconds}.xlsx`;

            // Download the file
            XLSX.writeFile(wb, filename);
            showToast('Excel export completed successfully', 'success');
        }

        // Auto-suggest assignee based on department and issue type
        function suggestAssignee(department, issueType) {
            // Filter users by department
            const deptUsers = users.filter(u => u.department === department && u.role !== 'Admin');
            
            if (deptUsers.length === 0) {
                return null;
            }
            
            // Prefer department lead
            const lead = deptUsers.find(u => u.role === 'Department Lead');
            if (lead) {
                return lead.id;
            }
            
            // Otherwise, find user with least open tickets
            const userTicketCounts = deptUsers.map(user => ({
                userId: user.id,
                count: tickets.filter(t => t.assignedTo === user.id && t.status !== 'Closed').length
            }));
            
            userTicketCounts.sort((a, b) => a.count - b.count);
            return userTicketCounts[0].userId;
        }

        // New Feature Functions
        function updateSLATimers() {
            tickets.forEach(ticket => {
                if (ticket.status !== 'Closed') {
                    const now = Date.now();
                    if (now > ticket.slaDeadline && !ticket.slaBreached) {
                        ticket.slaBreached = true;
                        ticket.history.push({
                            timestamp: new Date(),
                            action: 'SLA deadline breached - ticket auto-escalated',
                            user: 'System'
                        });
                        createNotification({
                            type: 'sla_breach',
                            message: `SLA BREACH: ${ticket.id} - ${ticket.title}`,
                            ticketId: ticket.id,
                            priority: 'Critical'
                        });
                    }
                }
            });
            
            // Update dashboard if visible
            if (currentUser && document.getElementById('dashboard').classList.contains('active')) {
                updateDashboard();
            }
        }

        function checkOverdueTickets() {
            const now = Date.now();
            tickets.forEach(ticket => {
                if (ticket.status !== 'Closed') {
                    const timeSinceUpdate = now - ticket.updatedAt.getTime();
                    // Send reminder if no update in 24 hours
                    if (timeSinceUpdate > 24 * 60 * 60 * 1000) {
                        if (!ticket.reminderSent || (now - ticket.reminderSent) > 24 * 60 * 60 * 1000) {
                            ticket.reminderSent = now;
                            createNotification({
                                type: 'reminder',
                                message: `Reminder: ${ticket.id} needs attention (no update in 24h)`,
                                ticketId: ticket.id,
                                priority: ticket.priority
                            });
                        }
                    }
                }
            });
        }

        function createNotification(data) {
            const notification = {
                id: notificationCounter++,
                ...data,
                timestamp: new Date(),
                read: false
            };
            notifications.unshift(notification);
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationCount');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                renderNotifications();
            }
        }

        function renderNotifications() {
            const listEl = document.getElementById('notificationList');
            if (notifications.length === 0) {
                listEl.innerHTML = '<div class="empty-state" style="padding: var(--space-16);">No notifications</div>';
            } else {
                listEl.innerHTML = notifications.map(notif => `
                    <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="handleNotificationClick('${notif.id}')">
                        <div style="font-size: var(--font-size-sm); margin-bottom: var(--space-4);">
                            ${getNotificationIcon(notif.type)} ${notif.message}
                        </div>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                            ${formatDateTime(notif.timestamp)}
                        </div>
                    </div>
                `).join('');
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'ticket_created': '<i class="fas fa-plus-circle" style="color: var(--color-success);"></i>',
                'sla_breach': '<i class="fas fa-exclamation-triangle" style="color: var(--color-error);"></i>',
                'mention': '<i class="fas fa-at" style="color: var(--color-primary);"></i>',
                'reminder': '<i class="fas fa-bell" style="color: var(--color-warning);"></i>',
                'comment_added': '<i class="fas fa-comment" style="color: var(--color-primary);"></i>'
            };
            return icons[type] || '<i class="fas fa-info-circle"></i>';
        }

        function handleNotificationClick(notifId) {
            const notification = notifications.find(n => n.id == notifId);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
                if (notification.ticketId) {
                    toggleNotifications();
                    openTicketModal(notification.ticketId);
                }
            }
        }

        function markAllRead() {
            notifications.forEach(n => n.read = true);
            updateNotificationBadge();
            renderNotifications();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-color-scheme', currentTheme);
            const icon = document.getElementById('themeIcon');
            icon.className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            showToast(`${currentTheme === 'dark' ? 'Dark' : 'Light'} mode activated`, 'success');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function performSearch() {
            const query = document.getElementById('globalSearch').value.trim();
            if (query.length === 0) {
                showToast('Please enter a search term', 'error');
                return;
            }
            handleGlobalSearch({ target: { value: query } });
        }
        
        function debounceSearch(e) {
            clearTimeout(searchDebounceTimer);
            const query = e.target.value.trim();
            
            // Show/hide clear button
            document.getElementById('clearSearchBtn').style.display = query ? 'block' : 'none';
            document.getElementById('clearFilterBtn').style.display = query ? 'inline-flex' : 'none';
            
            // Real-time search with debounce
            searchDebounceTimer = setTimeout(() => {
                if (query.length >= 2) {
                    handleGlobalSearch(e);
                }
            }, 500);
        }

        function handleGlobalSearch(e) {
            const query = e.target.value.trim();
            currentSearchQuery = query;
            
            if (query.length === 0) {
                hideSearchHistory();
                clearSearchResults();
                // Switch to dashboard view and show all tickets
                switchView('dashboard');
                updateDashboard();
                return;
            }
            
            if (query.length < 2) {
                return;
            }
            
            // Add to search history
            addToSearchHistory(query);
            hideSearchHistory();
            
            // Process search query
            const searchResults = processSearchQuery(query);
            
            // Switch to dashboard view to show results
            switchView('dashboard');
            
            // Display results
            displaySearchResults(searchResults, query);
        }

        function processSearchQuery(query) {
            const lowerQuery = query.toLowerCase();
            let filtered = [...tickets];
            
            // Apply role-based filtering first
            if (currentUser.role === 'Department Lead') {
                filtered = filtered.filter(t => t.department === currentUser.department);
            } else if (currentUser.role === 'Team Member') {
                filtered = filtered.filter(t => 
                    t.department === currentUser.department || 
                    t.assignedTo === currentUser.id ||
                    t.reporterEmail === currentUser.email
                );
            }
            
            // Check for shortcuts
            if (lowerQuery.startsWith('#')) {
                // Ticket ID search: #123 or #TKT-00123
                const ticketNum = lowerQuery.substring(1);
                filtered = filtered.filter(t => t.id.toLowerCase().includes(ticketNum));
            } else if (lowerQuery.startsWith('@')) {
                // Assignee search: @name
                const assigneeName = lowerQuery.substring(1);
                filtered = filtered.filter(t => {
                    const assignee = t.assignedTo ? users.find(u => u.id === t.assignedTo) : null;
                    return assignee && assignee.name.toLowerCase().includes(assigneeName);
                });
            } else if (lowerQuery.startsWith('dept:')) {
                // Department filter: dept:collections
                const dept = lowerQuery.substring(5).trim();
                filtered = filtered.filter(t => t.department.toLowerCase().includes(dept));
            } else if (lowerQuery.startsWith('status:')) {
                // Status filter: status:open
                const status = lowerQuery.substring(7).trim();
                filtered = filtered.filter(t => t.status.toLowerCase().includes(status));
            } else if (lowerQuery.startsWith('priority:')) {
                // Priority filter: priority:high
                const priority = lowerQuery.substring(9).trim();
                filtered = filtered.filter(t => t.priority.toLowerCase().includes(priority));
            } else {
                // Regular multi-field search (AND logic for multiple words)
                const keywords = lowerQuery.split(' ').filter(k => k.length > 0);
                
                filtered = filtered.filter(ticket => {
                    const searchableText = [
                        ticket.id,
                        ticket.title,
                        ticket.description,
                        ticket.reporterName,
                        ticket.reporterEmail,
                        ticket.department,
                        ticket.issueType,
                        ticket.priority,
                        ticket.status,
                        ...(ticket.tags || []),
                        ...ticket.comments.map(c => c.text)
                    ].join(' ').toLowerCase();
                    
                    const assignee = ticket.assignedTo ? users.find(u => u.id === ticket.assignedTo) : null;
                    if (assignee) {
                        searchableText += ' ' + assignee.name.toLowerCase();
                    }
                    
                    // Check if ALL keywords are present (AND logic)
                    return keywords.every(keyword => searchableText.includes(keyword));
                });
            }
            
            return filtered;
        }

        function displaySearchResults(results, query) {
            const headerEl = document.getElementById('searchResultsHeader');
            const recentTicketsEl = document.getElementById('recentTickets');
            
            if (results.length === 0) {
                headerEl.innerHTML = `
                    <div class="search-results-header">
                        <div>
                            <span class="search-match-count">No tickets found</span> matching "${escapeHtml(query)}"
                        </div>
                        <button class="btn btn-secondary" onclick="clearSearch()" style="padding: var(--space-4) var(--space-8);">
                            <i class="fas fa-times"></i> Clear Search
                        </button>
                    </div>
                    <div class="empty-state">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: var(--space-16); opacity: 0.5;"></i>
                        <p>No tickets match your search criteria</p>
                        <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Try different keywords or use advanced search filters</p>
                    </div>
                `;
                headerEl.style.display = 'block';
                recentTicketsEl.innerHTML = '';
                showToast('No tickets found matching your search', 'error');
            } else {
                headerEl.innerHTML = `
                    <div class="search-results-header">
                        <div>
                            <span class="search-match-count">Found ${results.length} ticket${results.length !== 1 ? 's' : ''}</span> matching "${escapeHtml(query)}"
                        </div>
                        <div style="display: flex; gap: var(--space-8);">
                            <button class="btn btn-secondary" onclick="exportSearchResults()" style="padding: var(--space-4) var(--space-8);">
                                <i class="fas fa-file-excel"></i> Export Results
                            </button>
                            <button class="btn btn-secondary" onclick="clearSearch()" style="padding: var(--space-4) var(--space-8);">
                                <i class="fas fa-times"></i> Clear Search
                            </button>
                        </div>
                    </div>
                `;
                headerEl.style.display = 'block';
                
                // Render results with keyword highlighting
                recentTicketsEl.innerHTML = results.map(ticket => createTicketCard(ticket, query)).join('');
                
                showToast(`Found ${results.length} ticket${results.length !== 1 ? 's' : ''}`, 'success');
            }
        }

        function clearSearch() {
            document.getElementById('globalSearch').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            document.getElementById('clearFilterBtn').style.display = 'none';
            currentSearchQuery = '';
            clearSearchResults();
            
            // Clear quick filters
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            
            // Switch to dashboard and show all tickets
            switchView('dashboard');
            updateDashboard();
            
            showToast('Search cleared - showing all tickets', 'success');
        }

        function clearSearchResults() {
            document.getElementById('searchResultsHeader').style.display = 'none';
            document.getElementById('searchResultsHeader').innerHTML = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function highlightText(text, query) {
            if (!query || query.length < 2) return escapeHtml(text);
            
            const keywords = query.toLowerCase().split(' ').filter(k => k.length > 1);
            let result = escapeHtml(text);
            
            keywords.forEach(keyword => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                result = result.replace(regex, '<span class="highlight">$1</span>');
            });
            
            return result;
        }

        function addToSearchHistory(query) {
            // Remove duplicate if exists
            searchHistory = searchHistory.filter(q => q.toLowerCase() !== query.toLowerCase());
            
            // Add to beginning
            searchHistory.unshift(query);
            
            // Keep only last 10
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }
        }

        function showSearchHistory() {
            if (searchHistory.length === 0) return;
            
            const dropdown = createSearchHistoryDropdown();
            const container = document.querySelector('.search-container');
            
            // Remove existing dropdown
            const existing = document.getElementById('searchHistoryDropdown');
            if (existing) existing.remove();
            
            container.appendChild(dropdown);
        }

        function hideSearchHistory() {
            const dropdown = document.getElementById('searchHistoryDropdown');
            if (dropdown) dropdown.remove();
        }

        function createSearchHistoryDropdown() {
            const dropdown = document.createElement('div');
            dropdown.id = 'searchHistoryDropdown';
            dropdown.className = 'search-history-dropdown active';
            
            dropdown.innerHTML = `
                <div style="padding: var(--space-8) var(--space-12); border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); color: var(--color-text-secondary); text-transform: uppercase;">Recent Searches</span>
                    <button onclick="clearSearchHistory()" style="background: none; border: none; color: var(--color-text-secondary); cursor: pointer; font-size: var(--font-size-xs);">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                ${searchHistory.map(query => `
                    <div class="search-history-item" onclick="applySearchHistory('${escapeHtml(query).replace(/'/g, "\\'")}')"> 
                        <i class="fas fa-history"></i>
                        <span>${escapeHtml(query)}</span>
                    </div>
                `).join('')}
            `;
            
            return dropdown;
        }

        function applySearchHistory(query) {
            document.getElementById('globalSearch').value = query;
            hideSearchHistory();
            handleGlobalSearch({ target: { value: query } });
        }

        function clearSearchHistory() {
            searchHistory = [];
            hideSearchHistory();
            showToast('Search history cleared', 'success');
        }

        function handleSearchKeydown(e) {
            if (e.key === 'Escape') {
                hideSearchHistory();
                e.target.blur();
            }
        }

        function toggleAdvancedSearch() {
            const panel = document.getElementById('advancedSearchPanel');
            panel.classList.toggle('active');
            advancedSearchActive = panel.classList.contains('active');
            
            if (advancedSearchActive) {
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function populateAdvancedSearchAssignees() {
            const select = document.getElementById('advSearchAssignee');
            const currentOptions = select.innerHTML;
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.department})`;
                select.appendChild(option);
            });
        }

        function performAdvancedSearch() {
            let filtered = [...tickets];
            
            // Apply role-based filtering
            if (currentUser.role === 'Department Lead') {
                filtered = filtered.filter(t => t.department === currentUser.department);
            } else if (currentUser.role === 'Team Member') {
                filtered = filtered.filter(t => 
                    t.department === currentUser.department || 
                    t.assignedTo === currentUser.id ||
                    t.reporterEmail === currentUser.email
                );
            }
            
            // Ticket ID
            const ticketId = document.getElementById('advSearchTicketId').value.trim().toUpperCase();
            if (ticketId) {
                filtered = filtered.filter(t => t.id.includes(ticketId) || t.id.includes('TKT-' + ticketId.replace(/^TKT-/, '')));
            }
            
            // Title
            const title = document.getElementById('advSearchTitle').value.trim().toLowerCase();
            if (title) {
                filtered = filtered.filter(t => t.title.toLowerCase().includes(title));
            }
            
            // Description
            const description = document.getElementById('advSearchDescription').value.trim().toLowerCase();
            if (description) {
                filtered = filtered.filter(t => t.description.toLowerCase().includes(description));
            }
            
            // Reporter
            const reporter = document.getElementById('advSearchReporter').value.trim().toLowerCase();
            if (reporter) {
                filtered = filtered.filter(t => 
                    t.reporterName.toLowerCase().includes(reporter) ||
                    t.reporterEmail.toLowerCase().includes(reporter)
                );
            }
            
            // Assignee
            const assignee = document.getElementById('advSearchAssignee').value;
            if (assignee === 'unassigned') {
                filtered = filtered.filter(t => !t.assignedTo);
            } else if (assignee) {
                filtered = filtered.filter(t => t.assignedTo == assignee);
            }
            
            // Department
            const dept = document.getElementById('advSearchDepartment').value;
            if (dept) {
                filtered = filtered.filter(t => t.department === dept);
            }
            
            // Status (multiple)
            const statusSelect = document.getElementById('advSearchStatus');
            const selectedStatuses = Array.from(statusSelect.selectedOptions).map(opt => opt.value);
            if (selectedStatuses.length > 0) {
                filtered = filtered.filter(t => selectedStatuses.includes(t.status));
            }
            
            // Priority (multiple)
            const prioritySelect = document.getElementById('advSearchPriority');
            const selectedPriorities = Array.from(prioritySelect.selectedOptions).map(opt => opt.value);
            if (selectedPriorities.length > 0) {
                filtered = filtered.filter(t => selectedPriorities.includes(t.priority));
            }
            
            // Issue Type
            const issueType = document.getElementById('advSearchIssueType').value;
            if (issueType) {
                filtered = filtered.filter(t => t.issueType === issueType);
            }
            
            // SLA Status
            const slaStatus = document.getElementById('advSearchSLA').value;
            if (slaStatus) {
                const now = Date.now();
                filtered = filtered.filter(t => {
                    if (t.status === 'Closed') return false;
                    const timeRemaining = t.slaDeadline - now;
                    const totalTime = slaConfig[t.priority];
                    const percentRemaining = (timeRemaining / totalTime) * 100;
                    
                    if (slaStatus === 'within') return percentRemaining >= 50;
                    if (slaStatus === 'approaching') return percentRemaining < 50 && percentRemaining >= 0;
                    if (slaStatus === 'overdue') return percentRemaining < 0;
                });
            }
            
            // Date Range
            const dateFrom = document.getElementById('advSearchDateFrom').value;
            const dateTo = document.getElementById('advSearchDateTo').value;
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(t => new Date(t.createdAt) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59);
                filtered = filtered.filter(t => new Date(t.createdAt) <= toDate);
            }
            
            // Tags
            const tags = document.getElementById('advSearchTags').value.trim().toLowerCase();
            if (tags) {
                filtered = filtered.filter(t => 
                    t.tags && t.tags.some(tag => tag.toLowerCase().includes(tags))
                );
            }
            
            // Comments
            const comments = document.getElementById('advSearchComments').value.trim().toLowerCase();
            if (comments) {
                filtered = filtered.filter(t => 
                    t.comments.some(c => c.text.toLowerCase().includes(comments))
                );
            }
            
            // Display results
            const searchSummary = 'Advanced Search';
            displaySearchResults(filtered, searchSummary);
            toggleAdvancedSearch();
            showToast(`Found ${filtered.length} ticket${filtered.length !== 1 ? 's' : ''}`, 'success');
        }

        function resetAdvancedSearch() {
            document.getElementById('advSearchTicketId').value = '';
            document.getElementById('advSearchTitle').value = '';
            document.getElementById('advSearchDescription').value = '';
            document.getElementById('advSearchReporter').value = '';
            document.getElementById('advSearchAssignee').value = '';
            document.getElementById('advSearchDepartment').value = '';
            document.getElementById('advSearchStatus').selectedIndex = -1;
            document.getElementById('advSearchPriority').selectedIndex = -1;
            document.getElementById('advSearchIssueType').value = '';
            document.getElementById('advSearchSLA').value = '';
            document.getElementById('advSearchDateFrom').value = '';
            document.getElementById('advSearchDateTo').value = '';
            document.getElementById('advSearchTags').value = '';
            document.getElementById('advSearchComments').value = '';
            showToast('Advanced search filters reset', 'success');
        }

        function saveCurrentSearch() {
            const searchName = prompt('Enter a name for this saved search:');
            if (!searchName || !searchName.trim()) return;
            
            const searchCriteria = {
                id: Date.now(),
                name: searchName.trim(),
                criteria: {
                    ticketId: document.getElementById('advSearchTicketId').value,
                    title: document.getElementById('advSearchTitle').value,
                    description: document.getElementById('advSearchDescription').value,
                    reporter: document.getElementById('advSearchReporter').value,
                    assignee: document.getElementById('advSearchAssignee').value,
                    department: document.getElementById('advSearchDepartment').value,
                    status: Array.from(document.getElementById('advSearchStatus').selectedOptions).map(o => o.value),
                    priority: Array.from(document.getElementById('advSearchPriority').selectedOptions).map(o => o.value),
                    issueType: document.getElementById('advSearchIssueType').value,
                    sla: document.getElementById('advSearchSLA').value,
                    dateFrom: document.getElementById('advSearchDateFrom').value,
                    dateTo: document.getElementById('advSearchDateTo').value,
                    tags: document.getElementById('advSearchTags').value,
                    comments: document.getElementById('advSearchComments').value
                },
                createdBy: currentUser.id,
                createdAt: new Date()
            };
            
            savedSearches.push(searchCriteria);
            updateSavedSearchCount();
            showToast('Search saved successfully', 'success');
        }

        function toggleSavedSearches() {
            const menu = document.getElementById('savedSearchesMenu');
            menu.classList.toggle('active');
            
            if (menu.classList.contains('active')) {
                renderSavedSearches();
            }
        }

        function renderSavedSearches() {
            const menu = document.getElementById('savedSearchesMenu');
            
            if (savedSearches.length === 0) {
                menu.innerHTML = '<div style="padding: var(--space-16); text-align: center; color: var(--color-text-secondary); font-size: var(--font-size-sm);">No saved searches</div>';
                return;
            }
            
            menu.innerHTML = savedSearches.map(search => `
                <div class="saved-search-item">
                    <div onclick="applySavedSearch(${search.id})" style="flex: 1;">
                        <div style="font-weight: var(--font-weight-semibold);">${escapeHtml(search.name)}</div>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-4);">
                            Saved ${formatDate(search.createdAt)}
                        </div>
                    </div>
                    <button onclick="deleteSavedSearch(${search.id}); event.stopPropagation();" style="background: none; border: none; color: var(--color-error); cursor: pointer; padding: var(--space-4);">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function applySavedSearch(searchId) {
            const search = savedSearches.find(s => s.id === searchId);
            if (!search) return;
            
            // Populate advanced search fields
            document.getElementById('advSearchTicketId').value = search.criteria.ticketId || '';
            document.getElementById('advSearchTitle').value = search.criteria.title || '';
            document.getElementById('advSearchDescription').value = search.criteria.description || '';
            document.getElementById('advSearchReporter').value = search.criteria.reporter || '';
            document.getElementById('advSearchAssignee').value = search.criteria.assignee || '';
            document.getElementById('advSearchDepartment').value = search.criteria.department || '';
            
            const statusSelect = document.getElementById('advSearchStatus');
            Array.from(statusSelect.options).forEach(opt => {
                opt.selected = search.criteria.status.includes(opt.value);
            });
            
            const prioritySelect = document.getElementById('advSearchPriority');
            Array.from(prioritySelect.options).forEach(opt => {
                opt.selected = search.criteria.priority.includes(opt.value);
            });
            
            document.getElementById('advSearchIssueType').value = search.criteria.issueType || '';
            document.getElementById('advSearchSLA').value = search.criteria.sla || '';
            document.getElementById('advSearchDateFrom').value = search.criteria.dateFrom || '';
            document.getElementById('advSearchDateTo').value = search.criteria.dateTo || '';
            document.getElementById('advSearchTags').value = search.criteria.tags || '';
            document.getElementById('advSearchComments').value = search.criteria.comments || '';
            
            toggleSavedSearches();
            performAdvancedSearch();
        }

        function deleteSavedSearch(searchId) {
            if (confirm('Delete this saved search?')) {
                savedSearches = savedSearches.filter(s => s.id !== searchId);
                updateSavedSearchCount();
                renderSavedSearches();
                showToast('Saved search deleted', 'success');
            }
        }

        function updateSavedSearchCount() {
            document.getElementById('savedSearchCount').textContent = savedSearches.length;
        }

        function showGoToTicket() {
            const ticketId = prompt('Enter ticket number (e.g., TKT-00001 or 00001):');
            if (!ticketId || !ticketId.trim()) return;
            
            const normalized = ticketId.trim().toUpperCase();
            let ticket = tickets.find(t => t.id === normalized);
            
            // Try with TKT- prefix if not found
            if (!ticket && !normalized.startsWith('TKT-')) {
                ticket = tickets.find(t => t.id === 'TKT-' + normalized.replace(/^0+/, '').padStart(5, '0'));
            }
            
            // Try without leading zeros
            if (!ticket) {
                ticket = tickets.find(t => t.id.endsWith(normalized.replace(/^TKT-/, '').replace(/^0+/, '')));
            }
            
            if (ticket) {
                openTicketModal(ticket.id);
            } else {
                showToast('Ticket not found or you do not have permission to view it', 'error');
            }
        }

        function exportSearchResults() {
            showToast('Exporting search results...', 'success');
            
            // Get currently filtered tickets
            const currentResults = processSearchQuery(currentSearchQuery);
            
            if (currentResults.length === 0) {
                showToast('No results to export', 'error');
                return;
            }
            
            const exportData = currentResults.map(ticket => {
                const assignee = ticket.assignedTo ? users.find(u => u.id === ticket.assignedTo) : null;
                const comments = ticket.comments.map(c => `[${formatDateTimeDDMMYYYY(c.timestamp)}] ${c.author}: ${c.text}`).join(' | ');
                const tags = ticket.tags ? ticket.tags.join(', ') : '';
                
                return {
                    'Ticket ID': ticket.id,
                    'Title': ticket.title,
                    'Department': ticket.department,
                    'Issue Type': ticket.issueType,
                    'Priority': ticket.priority,
                    'Status': ticket.status,
                    'Description': ticket.description,
                    'Reporter Name': ticket.reporterName,
                    'Reporter Email': ticket.reporterEmail,
                    'Assigned To': assignee ? assignee.name : 'Unassigned',
                    'Tags': tags,
                    'Created Date': formatDateDDMMYYYY(ticket.createdAt),
                    'Last Updated': formatDateDDMMYYYY(ticket.updatedAt),
                    'Comments': comments || 'No comments'
                };
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, "Search Results");
            
            const searchTerm = currentSearchQuery.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
            const filename = `Search_Results_${searchTerm}_${formatDateDDMMYYYY(new Date()).replace(/-/g, '')}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showToast(`Exported ${currentResults.length} tickets successfully`, 'success');
        }

        function applyQuickFilter(filterType) {
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.quick-filter-btn').classList.add('active');
            
            let filtered = [];
            const now = new Date();
            const today = now.toDateString();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            switch(filterType) {
                case 'myTickets':
                    filtered = tickets.filter(t => 
                        t.reporterEmail === currentUser.email || t.assignedTo === currentUser.id
                    );
                    break;
                case 'unassigned':
                    filtered = tickets.filter(t => !t.assignedTo && t.status !== 'Closed');
                    break;
                case 'overdue':
                    filtered = tickets.filter(t => 
                        t.status !== 'Closed' && Date.now() > t.slaDeadline
                    );
                    break;
                case 'approachingSLA':
                    filtered = tickets.filter(t => {
                        if (t.status === 'Closed') return false;
                        const now = Date.now();
                        const timeRemaining = t.slaDeadline - now;
                        const totalTime = slaConfig[t.priority];
                        const percentRemaining = (timeRemaining / totalTime) * 100;
                        return percentRemaining < 50 && percentRemaining >= 0;
                    });
                    break;
                case 'today':
                    filtered = tickets.filter(t => {
                        const created = new Date(t.createdAt);
                        return created.toDateString() === today;
                    });
                    break;
                case 'thisWeek':
                    filtered = tickets.filter(t => new Date(t.createdAt) >= weekAgo);
                    break;
                case 'closedToday':
                    filtered = tickets.filter(t => {
                        if (t.status !== 'Closed') return false;
                        const updated = new Date(t.updatedAt);
                        return updated.toDateString() === today;
                    });
                    break;
                case 'recentUpdates':
                    const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    filtered = tickets.filter(t => new Date(t.updatedAt) >= last24h);
                    break;
                case 'highPriority':
                    filtered = tickets.filter(t => 
                        (t.priority === 'High' || t.priority === 'Critical') && t.status !== 'Closed'
                    );
                    break;
                case 'all':
                    filtered = tickets;
                    break;
            }
            
            // Display results in dashboard
            const headerEl = document.getElementById('searchResultsHeader');
            const filterName = event.target.closest('.quick-filter-btn').textContent.trim();
            
            headerEl.innerHTML = `
                <div class="search-results-header">
                    <div>
                        <span class="search-match-count">Found ${filtered.length} ticket${filtered.length !== 1 ? 's' : ''}</span> for filter: ${filterName}
                    </div>
                    <button class="btn btn-secondary" onclick="clearQuickFilter()" style="padding: var(--space-4) var(--space-8);">
                        <i class="fas fa-times"></i> Clear Filter
                    </button>
                </div>
            `;
            headerEl.style.display = 'block';
            
            document.getElementById('recentTickets').innerHTML = filtered.map(ticket => createTicketCard(ticket)).join('');
        }

        function clearQuickFilter() {
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            clearSearchResults();
            updateDashboard();
        }

        function renderFilteredTickets(filtered) {
            const ticketsListEl = document.getElementById('ticketsList');
            
            if (filtered.length === 0) {
                ticketsListEl.innerHTML = '<div class="empty-state">No tickets match the filter criteria</div>';
            } else {
                // Apply pagination
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const paginated = filtered.slice(start, end);
                
                ticketsListEl.innerHTML = paginated.map(ticket => createTicketCard(ticket)).join('');
                
                // Add pagination controls
                if (filtered.length > itemsPerPage) {
                    const totalPages = Math.ceil(filtered.length / itemsPerPage);
                    ticketsListEl.innerHTML += createPagination(totalPages);
                }
            }
        }

        function createPagination(totalPages) {
            let html = '<div class="pagination">';
            html += `<button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span>...</span>';
                }
            }
            
            html += `<button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
            html += '</div>';
            return html;
        }

        function changePage(page) {
            currentPage = page;
            renderTicketsList();
        }

        function renderAnalyticsCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart && chart.destroy());
            charts = {};
            
            // Department Performance Chart
            const deptCtx = document.getElementById('departmentChart');
            if (deptCtx) {
                const departments = ['Collections', 'Reconciliation', 'Billing', 'Sales', 'Other'];
                const deptData = departments.map(dept => {
                    return tickets.filter(t => t.department === dept).length;
                });
                
                charts.department = new Chart(deptCtx, {
                    type: 'bar',
                    data: {
                        labels: departments,
                        datasets: [{
                            label: 'Total Tickets',
                            data: deptData,
                            backgroundColor: ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
            
            // Trend Chart
            const trendCtx = document.getElementById('trendChart');
            if (trendCtx) {
                const last7Days = [];
                const createdData = [];
                const resolvedData = [];
                const now = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    const created = tickets.filter(t => {
                        const tDate = new Date(t.createdAt);
                        return tDate.toDateString() === date.toDateString();
                    }).length;
                    createdData.push(created);
                    
                    const resolved = tickets.filter(t => {
                        const tDate = new Date(t.updatedAt);
                        return t.status === 'Closed' && tDate.toDateString() === date.toDateString();
                    }).length;
                    resolvedData.push(resolved);
                }
                
                charts.trend = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [
                            {
                                label: 'Created',
                                data: createdData,
                                borderColor: '#FFC185',
                                backgroundColor: 'rgba(255, 193, 133, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Resolved',
                                data: resolvedData,
                                borderColor: '#1FB8CD',
                                backgroundColor: 'rgba(31, 184, 205, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Aging Chart
            const agingCtx = document.getElementById('agingChart');
            if (agingCtx) {
                const now = Date.now();
                const buckets = {
                    '0-2 days': 0,
                    '3-7 days': 0,
                    '8-14 days': 0,
                    '>14 days': 0
                };
                
                tickets.filter(t => t.status !== 'Closed').forEach(ticket => {
                    const age = (now - ticket.createdAt.getTime()) / (1000 * 60 * 60 * 24);
                    if (age <= 2) buckets['0-2 days']++;
                    else if (age <= 7) buckets['3-7 days']++;
                    else if (age <= 14) buckets['8-14 days']++;
                    else buckets['>14 days']++;
                });
                
                charts.aging = new Chart(agingCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(buckets),
                        datasets: [{
                            data: Object.values(buckets),
                            backgroundColor: ['#1FB8CD', '#FFC185', '#B4413C', '#944454']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Issue Type Chart
            const issueCtx = document.getElementById('issueTypeChart');
            if (issueCtx) {
                const issueTypes = {};
                tickets.forEach(t => {
                    issueTypes[t.issueType] = (issueTypes[t.issueType] || 0) + 1;
                });
                
                const sortedTypes = Object.entries(issueTypes)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                charts.issueType = new Chart(issueCtx, {
                    type: 'pie',
                    data: {
                        labels: sortedTypes.map(t => t[0]),
                        datasets: [{
                            data: sortedTypes.map(t => t[1]),
                            backgroundColor: ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Leaderboard
            renderLeaderboard();
        }

        function renderLeaderboard() {
            const assigneeStats = {};
            
            tickets.forEach(ticket => {
                if (ticket.assignedTo) {
                    if (!assigneeStats[ticket.assignedTo]) {
                        assigneeStats[ticket.assignedTo] = {
                            resolved: 0,
                            totalTime: 0,
                            count: 0
                        };
                    }
                    
                    if (ticket.status === 'Closed') {
                        assigneeStats[ticket.assignedTo].resolved++;
                        const resolutionTime = ticket.updatedAt - ticket.createdAt;
                        assigneeStats[ticket.assignedTo].totalTime += resolutionTime;
                        assigneeStats[ticket.assignedTo].count++;
                    }
                }
            });
            
            const leaderboard = Object.entries(assigneeStats)
                .map(([userId, stats]) => {
                    const user = users.find(u => u.id == userId);
                    const avgTime = stats.count > 0 ? stats.totalTime / stats.count / (1000 * 60 * 60) : 0;
                    return {
                        name: user ? user.name : 'Unknown',
                        resolved: stats.resolved,
                        avgTime: Math.round(avgTime)
                    };
                })
                .sort((a, b) => b.resolved - a.resolved)
                .slice(0, 5);
            
            const listEl = document.getElementById('leaderboardList');
            if (leaderboard.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No performance data available</div>';
            } else {
                listEl.innerHTML = leaderboard.map((item, index) => `
                    <div class="leaderboard-item">
                        <span class="leaderboard-rank ${index < 3 ? 'top' : ''}">#${index + 1}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: var(--font-weight-semibold);">${item.name}</div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                ${item.resolved} tickets resolved • Avg: ${item.avgTime}h
                            </div>
                        </div>
                        <span style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">
                            ${item.resolved}
                        </span>
                    </div>
                `).join('');
            }
        }

        function exportAnalytics() {
            showToast('Exporting analytics report...', 'success');
            // Use the existing exportToExcel function with analytics data
            exportToExcel();
        }

        // Knowledge Base Functions
        function filterKBArticles() {
            const query = document.getElementById('kbSearch').value.toLowerCase();
            const filtered = knowledgeBase.filter(article => 
                article.title.toLowerCase().includes(query) ||
                article.content.toLowerCase().includes(query) ||
                article.category.toLowerCase().includes(query)
            );
            renderKBArticles(filtered);
        }

        function renderKBArticles(articles = knowledgeBase) {
            const listEl = document.getElementById('kbList');
            if (articles.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No articles found</div>';
            } else {
                listEl.innerHTML = articles.map(article => `
                    <div class="kb-card" onclick="viewKBArticle('${article.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-8);">
                            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin: 0;">
                                ${article.title}
                            </h3>
                            ${currentUser && currentUser.role === 'Admin' ? `
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); deleteKBArticle('${article.id}')" style="padding: var(--space-4) var(--space-8);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: var(--space-8); margin-bottom: var(--space-8);">
                            <span class="badge badge-priority-medium">${article.category}</span>
                            <span class="badge badge-status-open">${article.department}</span>
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                            ${article.content.substring(0, 150)}...
                        </div>
                    </div>
                `).join('');
            }
        }

        function viewKBArticle(articleId) {
            const article = knowledgeBase.find(a => a.id === articleId);
            if (!article) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">${article.title}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: var(--space-16);">
                            <span class="badge badge-priority-medium">${article.category}</span>
                            <span class="badge badge-status-open">${article.department}</span>
                        </div>
                        <div style="white-space: pre-wrap; line-height: 1.8;">${article.content}</div>
                        <div style="margin-top: var(--space-24); padding-top: var(--space-16); border-top: 1px solid var(--color-border); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                            Created by ${article.createdBy} on ${formatDate(article.createdAt)}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showKBForm() {
            document.getElementById('kbFormSection').style.display = 'block';
            document.getElementById('kbForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelKBForm() {
            document.getElementById('kbFormSection').style.display = 'none';
            document.getElementById('kbForm').reset();
        }

        function deleteKBArticle(articleId) {
            if (confirm('Are you sure you want to delete this article?')) {
                const index = knowledgeBase.findIndex(a => a.id === articleId);
                if (index > -1) {
                    knowledgeBase.splice(index, 1);
                    renderKBArticles();
                    showToast('Article deleted successfully', 'success');
                }
            }
        }

        // Settings Functions
        // User Management Functions
        function renderUsersTable() {
            const container = document.getElementById('usersTableContainer');
            
            // Apply filters
            let filtered = users.filter(u => u.id !== 1); // Don't show system admin for editing
            
            const deptFilter = document.getElementById('filterUserDepartment').value;
            const roleFilter = document.getElementById('filterUserRole').value;
            const statusFilter = document.getElementById('filterUserStatus').value;
            
            if (deptFilter) filtered = filtered.filter(u => u.department === deptFilter);
            if (roleFilter) filtered = filtered.filter(u => u.role === roleFilter);
            if (statusFilter) filtered = filtered.filter(u => u.status === statusFilter);
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No users found</div>';
                return;
            }
            
            container.innerHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(user => `
                            <tr>
                                <td><strong>${user.userId}</strong></td>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td>${user.department}</td>
                                <td><span class="badge badge-status-assigned">${user.role}</span></td>
                                <td><span class="badge ${user.status === 'Active' ? 'badge-status-in-progress' : 'badge-status-closed'}">${user.status}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn action-btn-edit" onclick="editUser(${user.id})" title="Edit User">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="action-btn ${user.status === 'Active' ? 'action-btn-deactivate' : 'action-btn-edit'}" 
                                                onclick="toggleUserStatus(${user.id})" 
                                                title="${user.status === 'Active' ? 'Deactivate' : 'Activate'} User">
                                            <i class="fas fa-${user.status === 'Active' ? 'user-slash' : 'user-check'}"></i>
                                        </button>
                                        <button class="action-btn action-btn-delete" onclick="deleteUser(${user.id})" title="Delete User">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function showAddUserModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title"><i class="fas fa-user-plus"></i> Add New User</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="addUserError" class="error-message" style="display: none;"></div>
                        
                        <form id="addUserForm" onsubmit="handleAddUser(event)">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">User ID <span class="required">*</span></label>
                                    <input type="text" id="newUserId" class="form-input" required placeholder="e.g., john.doe">
                                    <span class="help-text">Alphanumeric, no spaces</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Full Name <span class="required">*</span></label>
                                    <input type="text" id="newUserName" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email <span class="required">*</span></label>
                                    <input type="email" id="newUserEmail" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Department <span class="required">*</span></label>
                                    <select id="newUserDepartment" class="form-select" required>
                                        <option value="">Select Department</option>
                                        <option value="Administration">Administration</option>
                                        <option value="Collections">Collections</option>
                                        <option value="Reconciliation">Reconciliation</option>
                                        <option value="Billing">Billing</option>
                                        <option value="Sales">Sales</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Role <span class="required">*</span></label>
                                    <select id="newUserRole" class="form-select" required>
                                        <option value="">Select Role</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Department Lead">Department Lead</option>
                                        <option value="Team Member">Team Member</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Password <span class="required">*</span></label>
                                    <input type="password" id="newUserPassword" class="form-input" required>
                                    <span class="help-text">Min 8 chars, 1 uppercase, 1 lowercase, 1 number</span>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add User</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function handleAddUser(e) {
            e.preventDefault();
            
            const userId = document.getElementById('newUserId').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const department = document.getElementById('newUserDepartment').value;
            const role = document.getElementById('newUserRole').value;
            const password = document.getElementById('newUserPassword').value;
            
            const errorEl = document.getElementById('addUserError');
            errorEl.style.display = 'none';
            
            // Validate user ID format
            if (!/^[a-zA-Z0-9.]+$/.test(userId)) {
                errorEl.textContent = 'User ID can only contain letters, numbers, and dots';
                errorEl.style.display = 'block';
                return;
            }
            
            // Check if user ID already exists
            if (users.some(u => u.userId === userId)) {
                errorEl.textContent = 'User ID already exists';
                errorEl.style.display = 'block';
                return;
            }
            
            // Validate password
            const validation = validatePassword(password);
            if (!validation.valid) {
                errorEl.textContent = validation.message;
                errorEl.style.display = 'block';
                return;
            }
            
            // Create new user
            const newUser = {
                id: users.length + 1,
                userId: userId,
                password: hashPassword(password),
                name: name,
                email: email,
                department: department,
                role: role,
                status: 'Active'
            };
            
            users.push(newUser);
            
            createNotification({
                type: 'info',
                message: `New user added: ${name} (${userId})`,
                priority: 'Low'
            });
            
            document.querySelector('.modal').remove();
            renderUsersTable();
            showToast('User added successfully', 'success');
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="editUserError" class="error-message" style="display: none;"></div>
                        
                        <form id="editUserForm" onsubmit="handleEditUser(event, ${userId})">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">User ID</label>
                                    <input type="text" class="form-input" value="${user.userId}" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Full Name <span class="required">*</span></label>
                                    <input type="text" id="editUserName" class="form-input" value="${user.name}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email <span class="required">*</span></label>
                                    <input type="email" id="editUserEmail" class="form-input" value="${user.email}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Department <span class="required">*</span></label>
                                    <select id="editUserDepartment" class="form-select" required>
                                        <option value="Administration" ${user.department === 'Administration' ? 'selected' : ''}>Administration</option>
                                        <option value="Collections" ${user.department === 'Collections' ? 'selected' : ''}>Collections</option>
                                        <option value="Reconciliation" ${user.department === 'Reconciliation' ? 'selected' : ''}>Reconciliation</option>
                                        <option value="Billing" ${user.department === 'Billing' ? 'selected' : ''}>Billing</option>
                                        <option value="Sales" ${user.department === 'Sales' ? 'selected' : ''}>Sales</option>
                                        <option value="Other" ${user.department === 'Other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Role <span class="required">*</span></label>
                                    <select id="editUserRole" class="form-select" required>
                                        <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                                        <option value="Department Lead" ${user.role === 'Department Lead' ? 'selected' : ''}>Department Lead</option>
                                        <option value="Team Member" ${user.role === 'Team Member' ? 'selected' : ''}>Team Member</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Reset Password (Optional)</label>
                                    <input type="password" id="editUserPassword" class="form-input" placeholder="Leave blank to keep current">
                                    <span class="help-text">Min 8 chars, 1 uppercase, 1 lowercase, 1 number</span>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update User</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function handleEditUser(e, userId) {
            e.preventDefault();
            
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const department = document.getElementById('editUserDepartment').value;
            const role = document.getElementById('editUserRole').value;
            const password = document.getElementById('editUserPassword').value;
            
            const errorEl = document.getElementById('editUserError');
            errorEl.style.display = 'none';
            
            // Validate password if provided
            if (password) {
                const validation = validatePassword(password);
                if (!validation.valid) {
                    errorEl.textContent = validation.message;
                    errorEl.style.display = 'block';
                    return;
                }
                user.password = hashPassword(password);
            }
            
            // Update user
            user.name = name;
            user.email = email;
            user.department = department;
            user.role = role;
            
            createNotification({
                type: 'info',
                message: `User updated: ${name}`,
                priority: 'Low'
            });
            
            document.querySelector('.modal').remove();
            renderUsersTable();
            showToast('User updated successfully', 'success');
        }
        
        function toggleUserStatus(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const newStatus = user.status === 'Active' ? 'Inactive' : 'Active';
            const action = newStatus === 'Active' ? 'activate' : 'deactivate';
            
            if (confirm(`Are you sure you want to ${action} ${user.name}?`)) {
                user.status = newStatus;
                
                createNotification({
                    type: 'info',
                    message: `User ${action}d: ${user.name}`,
                    priority: 'Low'
                });
                
                renderUsersTable();
                showToast(`User ${action}d successfully`, 'success');
            }
        }
        
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`Are you sure you want to permanently delete ${user.name}? This action cannot be undone.`)) {
                const index = users.findIndex(u => u.id === userId);
                if (index > -1) {
                    users.splice(index, 1);
                    
                    createNotification({
                        type: 'info',
                        message: `User deleted: ${user.name}`,
                        priority: 'Low'
                    });
                    
                    renderUsersTable();
                    showToast('User deleted successfully', 'success');
                }
            }
        }
        
        function renderUsersList() {
            const listEl = document.getElementById('usersList');
            listEl.innerHTML = `
                <div style="display: grid; gap: var(--space-12);">
                    ${users.map(user => `
                        <div class="leaderboard-item">
                            <div style="flex: 1;">
                                <div style="font-weight: var(--font-weight-semibold);">${user.name}</div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                    ${user.email} • ${user.role} • ${user.department}
                                </div>
                            </div>
                            ${currentUser && currentUser.role === 'Admin' ? `
                                <button class="btn btn-secondary" onclick="deactivateUser(${user.id})" style="padding: var(--space-4) var(--space-8);">
                                    <i class="fas fa-user-times"></i> Deactivate
                                </button>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showAddUserForm() {
            showToast('User management form would open here', 'success');
        }

        function showAddFieldForm() {
            showToast('Custom field form would open here', 'success');
        }

        function showAddIssueTypeForm() {
            showToast('Issue type form would open here', 'success');
        }

        function showAddStatusForm() {
            showToast('Status form would open here', 'success');
        }

        function deactivateUser(userId) {
            if (confirm('Are you sure you want to deactivate this user?')) {
                showToast('User deactivation would be processed here', 'success');
            }
        }

        function exportAuditLog() {
            const auditData = [];
            tickets.forEach(ticket => {
                ticket.history.forEach(entry => {
                    auditData.push({
                        'Ticket ID': ticket.id,
                        'Action': entry.action,
                        'User': entry.user,
                        'Timestamp': formatDateTimeDDMMYYYY(entry.timestamp),
                        'Ticket Status': ticket.status,
                        'Priority': ticket.priority
                    });
                });
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(auditData);
            XLSX.utils.book_append_sheet(wb, ws, "Audit Log");
            
            const filename = `Audit_Log_${formatDateDDMMYYYY(new Date()).replace(/-/g, '')}.xlsx`;
            XLSX.writeFile(wb, filename);
            showToast('Audit log exported successfully', 'success');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-dropdown')) {
                document.getElementById('userDropdownMenu').classList.remove('active');
            }
            if (!e.target.closest('.notification-badge')) {
                const notifPanel = document.getElementById('notificationPanel');
                if (notifPanel && !notifPanel.contains(e.target)) {
                    notifPanel.classList.remove('active');
                }
            }
        });
        
        // Initialize app on load
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Add KB form handler
        document.addEventListener('DOMContentLoaded', () => {
            const kbForm = document.getElementById('kbForm');
            if (kbForm) {
                kbForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const article = {
                        title: document.getElementById('kbTitle').value,
                        category: document.getElementById('kbCategory').value,
                        department: document.getElementById('kbDepartment').value,
                        content: document.getElementById('kbContent').value
                    };
                    createKBArticle(article);
                    cancelKBForm();
                    renderKBArticles();
                    showToast('Knowledge base article created successfully', 'success');
                });
            }
        });
    </script>
</body>
</html>
